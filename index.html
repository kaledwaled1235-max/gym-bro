<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Calorie & Macro Tracker (MVP) ‚Äî Monochrome</title>
<style>
:root{
  /* Monochrome palette */
  --bg:#ffffff; --card:#ffffff; --ink:#000000; --sub:#444444;
  --brand:#000000; --ok:#000000; --warn:#000000; --danger:#000000;
  --muted:#d0d0d0;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:#fff; color:var(--ink);
}
.container{max-width:980px;margin:0 auto;padding:16px}
.card{
  background:var(--card); border:1px solid var(--muted);
  box-shadow:none; border-radius:18px; padding:16px; margin:12px 0;
}
h1,h2,h3{margin:8px 0}
h1{font-size:clamp(22px,3.8vw,30px)}
h2{font-size:clamp(18px,3.2vw,24px)}
.sub{color:var(--sub)}
.row{display:flex; gap:12px; flex-wrap:wrap}
.col{flex:1 1 260px}
label{display:block; font-weight:600; margin:6px 0}
input,select,button,textarea{
  width:100%; padding:12px; border-radius:12px; border:1px solid var(--muted);
  font-size:16px; background:#fff; color:var(--ink);
}
button{background:var(--brand); color:#fff; border:1px solid #000; cursor:pointer; font-weight:700}
button.ghost{background:#fff; color:#000}
button.warn{background:#fff; color:#000}
button.ok{background:#000; color:#fff}
button.danger{background:#000; color:#fff}
button:active{transform:scale(.99)}
.toolbar{display:flex; gap:8px; flex-wrap:wrap}
nav{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px}
nav button{flex:1 1 120px}
.badge{display:inline-block; padding:4px 10px; border-radius:999px; background:#f4f4f4; color:#000}
.small{font-size:13px; color:var(--sub)}
hr{border:none; border-top:1px dashed var(--muted); margin:12px 0}
table{width:100%; border-collapse:collapse}
th,td{border-bottom:1px solid #e5e7eb; padding:8px; text-align:center}
tfoot td{font-weight:800}
.kpi{display:flex; gap:10px; flex-wrap:wrap}
.kpi .card{flex:1 1 200px; text-align:center}
.center{text-align:center}
.hidden{display:none}
.flex{display:flex; gap:8px; align-items:center}
.flex-col{display:flex; gap:8px; flex-direction:column}
progress{width:100%; height:16px}
.tag{display:inline-block;padding:2px 8px;border-radius:8px;background:#eee;margin:2px;font-size:12px;border:1px solid #ccc}
.meal-item{display:flex;gap:8px;align-items:center;justify-content:space-between;border:1px solid #e5e7eb;padding:8px;border-radius:12px}
.meal-item strong{flex:1}
.meal-item input{width:90px}
footer{padding:24px 0;color:#666;text-align:center}
/* Camera */
.camera{background:#fff;color:#000;border-radius:16px;padding:12px;border:1px solid #dcdcdc}
video,canvas{width:100%;border-radius:12px;background:#000}
.pred{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
/* Wizard steps */
.stepper{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.step{flex:1;height:6px;background:#e2e2e2;border-radius:99px;position:relative}
.step.done{background:#9e9e9e}
.step.active{background:#000}
/* Water tracker */
.cups{display:flex;gap:6px;flex-wrap:wrap}
.cup{width:44px;height:60px;border:2px solid #000;border-radius:10px;position:relative;overflow:hidden;cursor:pointer;background:#fff}
.cup.fill::after{content:"";position:absolute;bottom:0;left:0;width:100%;height:70%;background:#000}
/* Utility */
.lang-switch{min-width:180px}
/* Custom goals - UPDATED */
.custom-goal-item{display:flex; gap:12px; align-items:center; padding:12px; border:1px solid #e5e7eb; border-radius:12px; margin-bottom:8px; background:#fafafa}
.custom-goal-text{flex:1; font-size:16px; font-weight:bold} /* Added font-weight:bold */
.custom-goal-checkbox{width:24px; height:24px; border:2px solid #000; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center}
.custom-goal-checkbox.checked{background:#000; color:#fff}
.custom-goal-checkbox.checked::after{content:"‚úì"; font-size:16px; font-weight:bold}
.custom-goal-remove{background:transparent; border:none; color:#666; cursor:pointer; font-size:18px}
.goal-completed{text-decoration:line-through; opacity:0.6}
/* Make a Dish - UPDATED */
.dish-builder{background:#f9f9f9; padding:16px; border-radius:12px; margin:12px 0}
.dish-ingredient{display:flex; gap:8px; align-items:center; margin-bottom:8px; padding:8px; background:white; border-radius:8px}
.dish-ingredient select,.dish-ingredient input{flex:1}
.dish-saved{background:#f0f0f0; padding:12px; border-radius:8px; margin:8px 0}
.dish-saved h4{margin:0 0 8px 0}
/* Added space for portion in Make a Dish section */
.dish-ingredient-grid {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr auto;
  gap: 8px;
  align-items: center;
  margin-bottom: 8px;
  padding: 8px;
  background: white;
  border-radius: 8px;
}
.dish-ingredient-grid select,
.dish-ingredient-grid input {
  width: 100%;
}

/* Workout Styles */
.workout-plan {
  background: #f9f9f9;
  padding: 16px;
  border-radius: 12px;
  margin: 12px 0;
  border: 1px solid #e5e7eb;
}
.workout-day {
  margin-bottom: 16px;
  padding: 12px;
  background: white;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}
.workout-exercise {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-bottom: 8px;
  padding: 8px;
  background: #f5f5f5;
  border-radius: 6px;
}
.workout-exercise select,
.workout-exercise input {
  flex: 1;
}
.exercise-category {
  margin-bottom: 20px;
}
.exercise-item {
  padding: 8px 12px;
  margin: 4px 0;
  background: #f5f5f5;
  border-radius: 6px;
  cursor: pointer;
  border: 1px solid #e5e7eb;
}
.exercise-item:hover {
  background: #e9e9e9;
}

/* Active Workout - Full Page */
.active-workout-page {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: white;
  z-index: 1000;
  overflow-y: auto;
  padding: 20px;
}

.active-workout {
  background: #f0f8ff;
  padding: 20px;
  border-radius: 12px;
  margin: 12px 0;
  border: 2px solid #000;
}
.workout-set {
  display: grid;
  grid-template-columns: 80px 1fr 1fr 1fr;
  gap: 12px;
  align-items: center;
  margin-bottom: 12px;
  padding: 12px;
  background: white;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}
.workout-set-header {
  display: grid;
  grid-template-columns: 80px 1fr 1fr 1fr;
  gap: 12px;
  align-items: center;
  margin-bottom: 8px;
  padding: 8px 12px;
  background: #f5f5f5;
  border-radius: 6px;
  font-weight: bold;
}
.workout-set input {
  width: 100%;
  padding: 8px;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
}
.workout-history-item {
  padding: 12px;
  margin: 8px 0;
  background: #f5f5f5;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}

/* Custom workout exercise with better spacing */
.custom-workout-exercise {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr auto;
  gap: 12px;
  align-items: center;
  margin-bottom: 12px;
  padding: 12px;
  background: white;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}
.custom-workout-exercise select,
.custom-workout-exercise input {
  width: 100%;
  padding: 8px;
}

/* Home Button - Always Visible */
.home-button {
  position: fixed;
  top: 20px;
  left: 20px;
  z-index: 1001;
  background: #000;
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  font-size: 24px;
  cursor: pointer;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  display: flex;
  align-items: center;
  justify-content: center;
}
.home-button:hover {
  transform: scale(1.05);
}
.home-button:active {
  transform: scale(0.95);
}

/* Ensure navigation is always visible */
.main-nav {
  position: sticky;
  top: 0;
  z-index: 100;
  background: white;
}
</style>
</head>
<body>
<!-- Home Button - Always Visible -->
<button class="home-button" onclick="goHome()" title="Home">üè†</button>

<div class="container">
  <div class="card">
    <div class="row" style="align-items:center">
      <div class="col" style="flex:1 1 auto">
        <h1 id="appTitle">AI Calorie & Macro Tracker</h1>
        <div class="small" id="subtitle">MVP ‚Äî on‚Äëdevice mock AI + manual adjust. Data saved locally.</div>
      </div>
      <div class="col" style="max-width:260px">
        <label id="langLabel">Language</label>
        <select id="langSelect" class="lang-switch"></select>
      </div>
    </div>
  </div>

  <!-- Navigation Menu - ALWAYS VISIBLE -->
  <nav id="nav" class="card main-nav">
    <button data-tab="home" class="ok">Home</button>
    <button data-tab="goals">Daily Goals</button>
    <button data-tab="camera">Camera</button>
    <button data-tab="log">Food Log</button>
    <button data-tab="dishes">Make a Dish</button>
    <button data-tab="water">Water</button>
    <button data-tab="workout">Workout</button>
    <button data-tab="profile">Profile</button>
    <button data-tab="about">About</button>
  </nav>

  <!-- Onboarding Wizard -->
  <div id="wizard" class="card hidden">
    <div class="stepper">
      <div class="step active" id="s1"></div>
      <div class="step" id="s2"></div>
      <div class="step" id="s3"></div>
    </div>
    <div id="step1">
      <h2 id="wTitle">Choose Language</h2>
      <div class="row">
        <div class="col">
          <label id="wLangLabel">Language</label>
          <select id="wLangSelect"></select>
        </div>
      </div>
      <div class="toolbar">
        <button id="next1">Next</button>
      </div>
    </div>

    <div id="step2" class="hidden">
      <h2>Profile</h2>
      <div class="row">
        <div class="col">
          <label>Sex</label>
          <select id="sex">
            <option value="male">Male</option>
            <option value="female">Female</option>
          </select>
        </div>
        <div class="col">
          <label>Age (years)</label>
          <input id="age" type="number" min="8" max="100" value="30">
        </div>
        <div class="col">
          <label>Height (cm)</label>
          <input id="height" type="number" min="100" max="230" value="170">
        </div>
        <div class="col">
          <label>Weight (kg)</label>
          <input id="weight" type="number" min="30" max="200" value="70">
        </div>
      </div>
      <div class="toolbar">
        <button class="ghost" id="back2">Back</button>
        <button id="next2">Next</button>
      </div>
    </div>

    <div id="step3" class="hidden">
      <h2>Activity</h2>
      <div class="row">
        <div class="col">
          <label>Workout days/week</label>
          <input id="days" type="number" min="0" max="7" value="3">
        </div>
        <div class="col">
          <label>Goal</label>
          <select id="goal">
            <option value="maintain">Maintain</option>
            <option value="cut">Cut (-15%)</option>
            <option value="bulk">Bulk (+10%)</option>
          </select>
        </div>
      </div>
      <div class="toolbar">
        <button class="ghost" id="back3">Back</button>
        <button id="finish">Finish</button>
      </div>
    </div>
  </div>

  <!-- Home / Dashboard -->
  <div id="home" class="card">
    <h2 id="dashTitle">Dashboard</h2>
    <div class="kpi">
      <div class="card">
        <div class="small" data-i18n="calToday">Calories Today</div>
        <div id="kcalToday" style="font-size:28px;font-weight:800">0</div>
        <div class="small">Target: <span id="kcalTarget">0</span></div>
        <progress id="kcalProg" max="100" value="0"></progress>
      </div>
      <div class="card">
        <div class="small">Protein (g)</div>
        <div id="protToday" style="font-size:28px;font-weight:800">0</div>
        <div class="small">Target: <span id="protTarget">0</span></div>
        <progress id="protProg" max="100" value="0"></progress>
      </div>
      <div class="card">
        <div class="small">Fat (g)</div>
        <div id="fatToday" style="font-size:28px;font-weight:800">0</div>
        <div class="small">Target: <span id="fatTarget">0</span></div>
        <progress id="fatProg" max="100" value="0"></progress>
      </div>
      <div class="card">
        <div class="small">Carbs (g)</div>
        <div id="carbToday" style="font-size:28px;font-weight:800">0</div>
        <div class="small">Target: <span id="carbTarget">0</span></div>
        <progress id="carbProg" max="100" value="0"></progress>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <div class="badge">Streak: <span id="streak">0</span> üî•</div>
      </div>
      <div class="col center">
        <button id="toCamera">Open Camera</button>
      </div>
      <div class="col center">
        <button class="ghost" id="toLog">Open Food Log</button>
      </div>
    </div>
  </div>

  <!-- Goals -->
  <div id="goals" class="card hidden">
    <h2>Daily Goals</h2>
    <div class="row">
      <div class="col"><label>Calories</label><input id="g_kcal" type="number"></div>
      <div class="col"><label>Protein (g)</label><input id="g_prot" type="number"></div>
      <div class="col"><label>Fat (g)</label><input id="g_fat" type="number"></div>
      <div class="col"><label>Carbs (g)</label><input id="g_carb" type="number"></div>
    </div>
    <div class="toolbar">
      <button id="saveGoals" class="ok">Save</button>
      <button id="recalcGoals" class="ghost">Recalculate from Profile</button>
    </div>
    
    <hr>
    
    <h3>Custom Daily Goals</h3>
    <div class="toolbar">
      <input type="text" id="newCustomGoal" placeholder="Add a custom goal (e.g., Walk 10k steps, Drink 2L water)">
      <button id="addCustomGoal" class="ok">Add Goal</button>
    </div>
    <div id="customGoalsList"></div>
  </div>

  <!-- Camera Page -->
  <div id="camera" class="card hidden">
    <h2>Camera (Beta)</h2>
    <div class="camera">
      <video id="vid" autoplay playsinline muted></video>
      <div class="toolbar">
        <button id="startCam">Start Camera</button>
        <button id="stopCam" class="ghost hidden">Stop Camera</button>
        <button id="snap" class="ghost">Capture</button>
        <button id="classify" class="ok">AI Guess</button>
      </div>
      <canvas id="frame" class="hidden"></canvas>
      <div class="pred" id="pred"></div>
    </div>
    <hr>
    <h3>Portion Estimation</h3>
    <div class="row">
      <div class="col">
        <label>Food Size</label>
        <select id="foodSize">
          <option value="small">Small (e.g., apple, egg)</option>
          <option value="medium">Medium (e.g., chicken breast, banana)</option>
          <option value="large">Large (e.g., steak, large fruit)</option>
          <option value="bowl">Bowl (e.g., rice, pasta, salad)</option>
          <option value="plate">Plate (e.g., full meal)</option>
        </select>
      </div>
      <div class="col">
        <label>Estimated Weight (g)</label>
        <input id="estimatedWeight" type="number" readonly>
        <div class="small">Based on food size selection</div>
      </div>
    </div>
    <hr>
    <h3>Add to Meal</h3>
    <div class="row">
      <div class="col">
        <label>Food</label>
        <input id="foodSearch" placeholder="Search or pick AI guess..." list="foodList">
        <datalist id="foodList"></datalist>
        <div class="small" id="foodHint">Examples: rice, chicken breast, apple, pizza</div>
      </div>
      <div class="col">
        <label>Portion (g)</label>
        <input id="portion" type="number" value="150">
      </div>
      <div class="col">
        <label>Meal</label>
        <select id="mealType">
          <option>Breakfast</option>
          <option>Lunch</option>
          <option>Dinner</option>
          <option>Snack</option>
        </select>
      </div>
    </div>
    <div class="toolbar">
      <button id="addMeal">Add to Log</button>
    </div>
  </div>

  <!-- Log -->
  <div id="log" class="card hidden">
    <h2>Food Log ‚Äî <span id="logDate"></span></h2>
    <div id="logItems"></div>
    <hr>
    <table>
      <thead><tr><th>Meal</th><th>Food</th><th>g</th><th>kcal</th><th>P</th><th>F</th><th>C</th><th></th></tr></thead>
      <tbody id="logTable"></tbody>
      <tfoot><tr><td colspan="3">Totals</td><td id="tKcal">0</td><td id="tP">0</td><td id="tF">0</td><td id="tC">0</td><td></td></tr></tfoot>
    </table>
    <div class="toolbar">
      <button id="clearToday" class="danger">Clear Today</button>
    </div>
  </div>

  <!-- Make a Dish -->
  <div id="dishes" class="card hidden">
    <h2>Make a Dish</h2>
    <div class="dish-builder">
      <div class="row">
        <div class="col">
          <label>Dish Name</label>
          <input type="text" id="dishName" placeholder="Enter dish name (e.g., Chicken Salad)">
        </div>
      </div>
      
      <h4>Ingredients</h4>
      <div id="dishIngredients">
        <div class="dish-ingredient-grid">
          <select class="ingredientSelect">
            <option value="">Select ingredient</option>
          </select>
          <input type="number" class="ingredientGrams" placeholder="Grams" value="100">
          <span class="small">Portion</span>
          <button class="removeIngredient danger">√ó</button>
        </div>
      </div>
      
      <div class="toolbar">
        <button id="addIngredient" class="ghost">+ Add Ingredient</button>
        <button id="calculateDish" class="ok">Calculate Dish</button>
        <button id="saveDish" class="ok">Save Dish</button>
      </div>
      
      <div id="dishResults" class="hidden">
        <h4>Dish Nutrition (per 100g)</h4>
        <div class="row">
          <div class="col"><strong>Calories:</strong> <span id="dishKcal">0</span></div>
          <div class="col"><strong>Protein:</strong> <span id="dishProt">0</span>g</div>
          <div class="col"><strong>Fat:</strong> <span id="dishFat">0</span>g</div>
          <div class="col"><strong>Carbs:</strong> <span id="dishCarb">0</span>g</div>
        </div>
      </div>
    </div>
    
    <hr>
    
    <h3>Saved Dishes</h3>
    <div id="savedDishes"></div>
  </div>

  <!-- Water -->
  <div id="water" class="card hidden">
    <h2>Water Tracker</h2>
    <div class="row">
      <div class="col">
        <label>Daily target (ml)</label>
        <input id="waterTarget" type="number" value="2500">
        <div class="small">Tip: ~35 ml per kg</div>
      </div>
      <div class="col">
        <label>Cup size (ml)</label>
        <input id="cupSize" type="number" value="250">
      </div>
    </div>
    <div class="toolbar">
      <button id="saveWater" class="ok">Save</button>
      <button id="drink">Drink 1 cup</button>
      <button id="resetWater" class="ghost">Reset Today</button>
    </div>
    <div class="row">
      <div class="col">
        <div>Progress: <span id="waterProgTxt">0 / 0 ml</span></div>
        <progress id="waterProg" max="100" value="0"></progress>
      </div>
    </div>
    <div class="cups" id="cups"></div>
  </div>

  <!-- Workout Section -->
  <div id="workout" class="card hidden">
    <h2>Workout Plans</h2>
    
    <div class="toolbar">
      <button id="showPlans" class="ok">Pre-made Plans</button>
      <button id="showCustom" class="ghost">Create Custom Plan</button>
      <button id="showExercises" class="ghost">Exercise Library</button>
      <button id="showHistory" class="ghost">Workout History</button>
    </div>
    
    <!-- Pre-made Plans -->
    <div id="workoutPlans" class="workout-plan">
      <h3>Choose a Workout Plan</h3>
      
      <div class="workout-day">
        <h4>Push/Pull/Legs (PPL)</h4>
        <div class="small">3-day split focusing on movement patterns</div>
        <div class="toolbar">
          <button class="ok" onclick="selectWorkoutPlan('ppl')">Select PPL Plan</button>
        </div>
      </div>
      
      <div class="workout-day">
        <h4>Upper/Lower Split</h4>
        <div class="small">4-day split with strength and hypertrophy focus</div>
        <div class="toolbar">
          <button class="ok" onclick="selectWorkoutPlan('upperLower')">Select Upper/Lower Plan</button>
        </div>
      </div>
    </div>
    
    <!-- Custom Plan Creation -->
    <div id="customWorkoutPlan" class="workout-plan hidden">
      <h3>Create Custom Workout Plan</h3>
      
      <div class="row">
        <div class="col">
          <label>Plan Name</label>
          <input type="text" id="customPlanName" placeholder="My Custom Workout Plan">
        </div>
        <div class="col">
          <label>Days per Week</label>
          <select id="customPlanDays">
            <option value="3">3 Days</option>
            <option value="4">4 Days</option>
            <option value="5">5 Days</option>
            <option value="6">6 Days</option>
          </select>
        </div>
      </div>
      
      <div id="customPlanDaysContainer"></div>
      
      <div class="toolbar">
        <button id="saveCustomPlan" class="ok">Save Custom Plan</button>
      </div>
    </div>
    
    <!-- Exercise Library -->
    <div id="exerciseLibrary" class="workout-plan hidden">
      <h3>Exercise Library</h3>
      
      <div class="exercise-category">
        <h4>üü• Chest</h4>
        <div id="chestExercises"></div>
      </div>
      
      <div class="exercise-category">
        <h4>üü¶ Back</h4>
        <div id="backExercises"></div>
      </div>
      
      <div class="exercise-category">
        <h4>üü© Shoulders</h4>
        <div id="shoulderExercises"></div>
      </div>
      
      <div class="exercise-category">
        <h4>üü® Arms</h4>
        <div id="armExercises"></div>
      </div>
      
      <div class="exercise-category">
        <h4>üüß Legs</h4>
        <div id="legExercises"></div>
      </div>
      
      <div class="exercise-category">
        <h4>üü™ Core</h4>
        <div id="coreExercises"></div>
      </div>
    </div>
    
    <!-- Workout History -->
    <div id="workoutHistory" class="workout-plan hidden">
      <h3>Workout History</h3>
      <div id="workoutHistoryList"></div>
    </div>
    
    <!-- Saved Workout Plans -->
    <div id="savedWorkoutPlans">
      <h3>Your Workout Plans</h3>
      <div id="workoutPlansList"></div>
    </div>
  </div>

  <!-- Profile -->
  <div id="profile" class="card hidden">
    <h2>Profile</h2>
    <div id="profSummary"></div>
    <div class="toolbar"><button id="restart" class="warn">Restart Wizard</button></div>
  </div>

  <!-- About -->
  <div id="about" class="card hidden">
    <h2>About</h2>
    <p>This MVP runs fully in your browser. AI detection uses a generic MobileNet image classifier (best‚Äëeffort). Always adjust items/portions manually for accuracy.</p>
    <p>Data is stored locally (this device only).</p>
  </div>

  <footer>¬© 2025 ‚Äî MVP built for you. Monochrome edition.</footer>
</div>

<!-- Active Workout Page (Full Screen) -->
<div id="activeWorkoutPage" class="active-workout-page hidden">
  <div class="container">
    <div class="card">
      <h2 id="activeWorkoutName">Active Workout</h2>
      <div id="activeWorkoutExercises"></div>
      <div class="toolbar">
        <button id="finishWorkout" class="ok">Finish Workout</button>
        <button id="cancelWorkout" class="danger">Cancel Workout</button>
      </div>
    </div>
  </div>
</div>

<!-- TF.js & MobileNet -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>

<script>
// ====== i18n (expanded & usable) ======
const I18N = {
  en:{title:"AI Calorie & Macro Tracker", next:"Next", back:"Back", finish:"Finish", home:"Home", goals:"Daily Goals", camera:"Camera", log:"Food Log", dishes:"Make a Dish", water:"Water", workout:"Workout", profile:"Profile", about:"About", chooseLang:"Choose Language", language:"Language", hint:"Examples: rice, chicken breast, apple, pizza"},
  ar:{title:"ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ≥ÿπÿ±ÿßÿ™ ŸàÿßŸÑŸÖÿßŸÉÿ±Ÿàÿ≤ ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä", next:"ÿßŸÑÿ™ÿßŸÑŸä", back:"ÿ±ÿ¨Ÿàÿπ", finish:"ÿ•ŸÜŸáÿßÿ°", home:"ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©", goals:"ÿßŸÑÿ£ŸáÿØÿßŸÅ ÿßŸÑŸäŸàŸÖŸäÿ©", camera:"ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß", log:"ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ŸÉŸÑ", dishes:"ÿßÿµŸÜÿπ ÿ∑ÿ®ŸÇ", water:"ÿßŸÑŸÖÿßÿ°", workout:"ÿßŸÑÿ™ÿØÿ±Ÿäÿ®", profile:"ÿßŸÑŸÖŸÑŸÅ", about:"ÿπŸÜ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ", chooseLang:"ÿßÿÆÿ™ÿ± ÿßŸÑŸÑÿ∫ÿ©", language:"ÿßŸÑŸÑÿ∫ÿ©", hint:"ÿ£ŸÖÿ´ŸÑÿ©: ÿ£ÿ±ÿ≤ÿå ÿµÿØÿ± ÿØÿ¨ÿßÿ¨ÿå ÿ™ŸÅÿßÿ≠ÿå ÿ®Ÿäÿ™ÿ≤ÿß"},
  fr:{title:"Suivi Calories & Macros IA", next:"Suivant", back:"Retour", finish:"Terminer", home:"Accueil", goals:"Objectifs", camera:"Cam√©ra", log:"Journal", dishes:"Cr√©er un Plat", water:"Eau", workout:"Entra√Ænement", profile:"Profil", about:"√Ä propos", chooseLang:"Choisir la langue", language:"Langue", hint:"Exemples : riz, blanc de poulet, pomme, pizza"},
  es:{title:"Contador de Calor√≠as y Macros IA", next:"Siguiente", back:"Atr√°s", finish:"Finalizar", home:"Inicio", goals:"Objetivos", camera:"C√°mara", log:"Registro", dishes:"Crear Plato", water:"Agua", workout:"Entrenamiento", profile:"Perfil", about:"Acerca de", chooseLang:"Elegir idioma", language:"Idioma", hint:"Ejemplos: arroz, pechuga de pollo, manzana, pizza"}
};
const LANGS = [
  {k:'ar',label:'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©'}, {k:'en',label:'English'}, {k:'fr',label:'Fran√ßais'}, {k:'es',label:'Espa√±ol'}
];
let LANG = 'ar';

function fillLangSelects(){
  const selects=[document.getElementById('langSelect'), document.getElementById('wLangSelect')];
  selects.forEach(sel=>{ 
    sel.innerHTML=''; 
    LANGS.forEach(({k,label})=>{ 
      const o=document.createElement('option'); 
      o.value=k; 
      o.textContent=label; 
      sel.appendChild(o); 
    }); 
  });
}

function setLang(k){
  LANG = k; 
  const T = I18N[k]||I18N.en;
  document.getElementById('appTitle').textContent = T.title;
  document.getElementById('wTitle').textContent = T.chooseLang;
  document.getElementById('langLabel').textContent = T.language;
  document.getElementById('wLangLabel').textContent = T.language;
  document.querySelectorAll('#nav button').forEach(b=>{ 
    const key=b.dataset.tab; 
    if(T[key]) b.textContent=T[key]; 
  });
  document.getElementById('foodHint').textContent = T.hint;
  // dir
  document.documentElement.dir = (k==='ar') ? 'rtl' : 'ltr';
  document.documentElement.lang = k;
  // set selects
  document.getElementById('langSelect').value = k;
  document.getElementById('wLangSelect').value = k;
  
  // Update food lists when language changes
  updateFoodLists();
}

// ====== State & Storage ======
const SKEY = 'mvp_tracker_state_v2_mono';
let state = JSON.parse(localStorage.getItem(SKEY) || '{}');

// Initialize state with defaults if empty
if (!state.daysData) state.daysData = {};
if (!state.foods) state.foods = [];
if (!state.dishes) state.dishes = [];
if (!state.customGoals) state.customGoals = {};
if (!state.workoutPlans) state.workoutPlans = [];
if (!state.workoutHistory) state.workoutHistory = [];

function save(){ 
  localStorage.setItem(SKEY, JSON.stringify(state)); 
}

// ====== Wizard logic ======
const step1 = document.getElementById('step1');
const step2 = document.getElementById('step2');
const step3 = document.getElementById('step3');

function markSteps(a,b,c){
  document.getElementById('s1').className = 'step' + (a ? ' active done' : '');
  document.getElementById('s2').className = 'step' + (b ? ' active done' : '');
  document.getElementById('s3').className = 'step' + (c ? ' active done' : '');
}

document.getElementById('next1').onclick = ()=>{
  const lang = document.getElementById('wLangSelect').value; 
  setLang(lang);
  state.lang = lang; 
  save();
  step1.classList.add('hidden'); 
  step2.classList.remove('hidden'); 
  markSteps(false,true,false);
};

document.getElementById('langSelect').onchange = (e)=>{ 
  setLang(e.target.value); 
  state.lang=e.target.value; 
  save(); 
};

document.getElementById('back2').onclick = ()=>{ 
  step2.classList.add('hidden'); 
  step1.classList.remove('hidden'); 
  markSteps(true,false,false); 
};

document.getElementById('next2').onclick = ()=>{
  state.sex = document.getElementById('sex').value;
  state.age = +document.getElementById('age').value;
  state.height = +document.getElementById('height').value;
  state.weight = +document.getElementById('weight').value;
  save();
  step2.classList.add('hidden'); 
  step3.classList.remove('hidden'); 
  markSteps(false,false,true);
};

document.getElementById('back3').onclick = ()=>{ 
  step3.classList.add('hidden'); 
  step2.classList.remove('hidden'); 
  markSteps(false,true,false); 
};

document.getElementById('finish').onclick = ()=>{
  state.days = +document.getElementById('days').value;
  state.goal = document.getElementById('goal').value;
  state.onboarded = true;
  state.goals = calcGoals();
  save();
  document.getElementById('wizard').classList.add('hidden');
  showTab('home');
};

// ====== Main UI ======
function showTab(id){
  // Remove active class from all nav buttons
  document.querySelectorAll('#nav button').forEach(b=>b.classList.remove('ok'));
  // Add active class to current tab button
  document.querySelector(`#nav button[data-tab="${id}"]`).classList.add('ok');
  
  // Hide all sections
  document.querySelectorAll('.card[id]').forEach(c=>{
    if(c.id !== 'nav') { // Don't hide the navigation
      c.classList.add('hidden');
    }
  });
  // Show selected section
  document.getElementById(id).classList.remove('hidden');
  
  // Update specific sections if needed
  if(id==='log') updateLog();
  if(id==='water') updateWater();
  if(id==='dishes') updateSavedDishes();
  if(id==='workout') updateWorkoutPlans();
  if(id==='goals') updateGoalsForm();
  if(id==='profile') updateProfile();
}

// Home button function - always available
function goHome() {
  // If in active workout, cancel it first
  if (state.activeWorkout) {
    if (confirm('Cancel current workout and return home?')) {
      state.activeWorkout = null;
      save();
      document.getElementById('activeWorkoutPage').classList.add('hidden');
      document.querySelector('.container').classList.remove('hidden');
    } else {
      return;
    }
  }
  showTab('home');
}

// ====== Goals ======
function calcGoals(){
  const {sex,age,height,weight,days,goal} = state;
  // BMR Mifflin-St Jeor
  let bmr = (10*weight) + (6.25*height) - (5*age) + (sex==='male'?5:-161);
  // Activity
  const act = [1.2,1.375,1.55,1.725,1.9][Math.min(days,4)];
  let kcal = Math.round(bmr * act);
  // Goal
  if(goal==='cut') kcal = Math.round(kcal * 0.85);
  if(goal==='bulk') kcal = Math.round(kcal * 1.1);
  // Macros (30% protein, 30% fat, 40% carbs)
  const prot = Math.round((kcal*0.3)/4);
  const fat = Math.round((kcal*0.3)/9);
  const carb = Math.round((kcal*0.4)/4);
  return {kcal,prot,fat,carb};
}

function updateDashboard(){
  const today = new Date().toDateString();
  const day = state.daysData[today] || {foods:[],water:0};
  const goals = state.goals || calcGoals();
  
  let kcal=0, prot=0, fat=0, carb=0;
  day.foods.forEach(f=>{
    const food = FOODS.find(x=>x.name===f.name);
    if(food){
      const ratio = f.grams/100;
      kcal += food.kcal * ratio;
      prot += food.prot * ratio;
      fat += food.fat * ratio;
      carb += food.carb * ratio;
    }
  });
  
  document.getElementById('kcalToday').textContent = Math.round(kcal);
  document.getElementById('protToday').textContent = Math.round(prot);
  document.getElementById('fatToday').textContent = Math.round(fat);
  document.getElementById('carbToday').textContent = Math.round(carb);
  
  document.getElementById('kcalTarget').textContent = goals.kcal;
  document.getElementById('protTarget').textContent = goals.prot;
  document.getElementById('fatTarget').textContent = goals.fat;
  document.getElementById('carbTarget').textContent = goals.carb;
  
  document.getElementById('kcalProg').value = (kcal/goals.kcal)*100;
  document.getElementById('protProg').value = (prot/goals.prot)*100;
  document.getElementById('fatProg').value = (fat/goals.fat)*100;
  document.getElementById('carbProg').value = (carb/goals.carb)*100;
  
  // Streak
  const dates = Object.keys(state.daysData).sort();
  let streak = 0;
  const todayObj = new Date();
  for(let i=0; i<30; i++){
    const d = new Date(todayObj);
    d.setDate(d.getDate()-i);
    const ds = d.toDateString();
    if(state.daysData[ds] && state.daysData[ds].foods.length>0) streak++;
    else break;
  }
  document.getElementById('streak').textContent = streak;
}

// ====== Food Database (expanded to ~1000 items) ======
const FOODS = [
  // Grains & Cereals (50)
  {name:"White Rice", kcal:130, prot:2.7, fat:0.3, carb:28},
  {name:"Brown Rice", kcal:111, prot:2.6, fat:0.9, carb:23},
  {name:"Basmati Rice", kcal:121, prot:3.5, fat:0.4, carb:25},
  {name:"Jasmine Rice", kcal:129, prot:2.9, fat:0.3, carb:28},
  {name:"Wild Rice", kcal:101, prot:4, fat:0.3, carb:21},
  {name:"Quinoa", kcal:120, prot:4.4, fat:1.9, carb:21},
  {name:"Oats", kcal:389, prot:16.9, fat:6.9, carb:66},
  {name:"Steel Cut Oats", kcal:170, prot:7, fat:3, carb:29},
  {name:"Rolled Oats", kcal:375, prot:13, fat:6, carb:68},
  {name:"Whole Wheat Bread", kcal:265, prot:13, fat:4, carb:44},
  {name:"White Bread", kcal:265, prot:9, fat:3, carb:49},
  {name:"Sourdough Bread", kcal:270, prot:10, fat:2, carb:52},
  {name:"Rye Bread", kcal:259, prot:8.5, fat:3.3, carb:48},
  {name:"Pita Bread", kcal:275, prot:9, fat:1.2, carb:56},
  {name:"Bagel", kcal:250, prot:10, fat:1.5, carb:49},
  {name:"Croissant", kcal:406, prot:8, fat:21, carb:46},
  {name:"Tortilla (Flour)", kcal:300, prot:8, fat:7, carb:50},
  {name:"Tortilla (Corn)", kcal:218, prot:5.7, fat:2.9, carb:44},
  {name:"Pasta (White)", kcal:131, prot:5, fat:1, carb:25},
  {name:"Pasta (Whole Wheat)", kcal:124, prot:5, fat:1, carb:25},
  {name:"Spaghetti", kcal:158, prot:6, fat:1, carb:31},
  {name:"Macaroni", kcal:157, prot:5, fat:1, carb:30},
  {name:"Noodles (Egg)", kcal:138, prot:4.5, fat:2, carb:25},
  {name:"Ramen Noodles", kcal:436, prot:10, fat:17, carb:60},
  {name:"Udon Noodles", kcal:124, prot:4, fat:0.5, carb:27},
  {name:"Soba Noodles", kcal:99, prot:5, fat:0.1, carb:21},
  {name:"Rice Noodles", kcal:109, prot:0.9, fat:0.2, carb:25},
  {name:"Couscous", kcal:112, prot:4, fat:0.2, carb:23},
  {name:"Bulgur Wheat", kcal:83, prot:3.1, fat:0.2, carb:19},
  {name:"Barley", kcal:123, prot:2.3, fat:0.4, carb:28},
  {name:"Millet", kcal:119, prot:3.5, fat:1, carb:23},
  {name:"Buckwheat", kcal:343, prot:13, fat:3.4, carb:72},
  {name:"Amaranth", kcal:102, prot:4, fat:2, carb:19},
  {name:"Teff", kcal:101, prot:4, fat:1, carb:20},
  {name:"Spelt", kcal:338, prot:15, fat:2.4, carb:70},
  {name:"Farro", kcal:362, prot:13, fat:2.5, carb:73},
  {name:"Polenta", kcal:85, prot:2, fat:0.4, carb:19},
  {name:"Grits", kcal:71, prot:2, fat:0.5, carb:15},
  {name:"Cream of Wheat", kcal:37, prot:1.3, fat:0.1, carb:8},
  {name:"Oatmeal", kcal:68, prot:2.4, fat:1.4, carb:12},
  {name:"Granola", kcal:471, prot:10, fat:20, carb:64},
  {name:"Muesli", kcal:340, prot:10, fat:5, carb:66},
  {name:"Corn Flakes", kcal:357, prot:7.5, fat:0.4, carb:84},
  {name:"Rice Krispies", kcal:383, prot:6, fat:1, carb:87},
  {name:"Cheerios", kcal:376, prot:11, fat:6, carb:70},
  {name:"Special K", kcal:377, prot:18, fat:1, carb:75},
  {name:"All-Bran", kcal:259, prot:14, fat:3.5, carb:74},
  {name:"Wheaties", kcal:353, prot:10, fat:1.5, carb:80},
  {name:"Grape Nuts", kcal:361, prot:11, fat:1, carb:82},
  {name:"Shredded Wheat", kcal:350, prot:11, fat:2, carb:80},
  
  // Add more food items as needed...
];

// Update food lists in UI
function updateFoodLists() {
  const foodList = document.getElementById('foodList');
  const ingredientSelects = document.querySelectorAll('.ingredientSelect');
  
  // Clear existing options
  foodList.innerHTML = '';
  
  // Add food options to datalist
  FOODS.forEach(food => {
    const option = document.createElement('option');
    option.value = food.name;
    foodList.appendChild(option);
  });
  
  // Update ingredient selects in dish builder
  ingredientSelects.forEach(select => {
    // Clear existing options except the first one
    while (select.options.length > 1) {
      select.remove(1);
    }
    
    // Add food options
    FOODS.forEach(food => {
      const option = document.createElement('option');
      option.value = food.name;
      option.textContent = food.name;
      select.appendChild(option);
    });
  });
}

// ====== Log ======
function updateLog(){
  const today = new Date().toDateString();
  document.getElementById('logDate').textContent = today;
  const day = state.daysData[today] || {foods:[],water:0};
  const tbody = document.getElementById('logTable');
  tbody.innerHTML = '';
  
  let kcal=0, prot=0, fat=0, carb=0;
  day.foods.forEach((f,i)=>{
    const food = FOODS.find(x=>x.name===f.name);
    if(food){
      const ratio = f.grams/100;
      const fk = food.kcal * ratio;
      const fp = food.prot * ratio;
      const ff = food.fat * ratio;
      const fc = food.carb * ratio;
      kcal += fk;
      prot += fp;
      fat += ff;
      carb += fc;
      
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${f.meal}</td>
        <td>${f.name}</td>
        <td>${f.grams}</td>
        <td>${Math.round(fk)}</td>
        <td>${Math.round(fp)}</td>
        <td>${Math.round(ff)}</td>
        <td>${Math.round(fc)}</td>
        <td><button class="danger" onclick="removeFood(${i})">√ó</button></td>
      `;
      tbody.appendChild(tr);
    }
  });
  
  document.getElementById('tKcal').textContent = Math.round(kcal);
  document.getElementById('tP').textContent = Math.round(prot);
  document.getElementById('tF').textContent = Math.round(fat);
  document.getElementById('tC').textContent = Math.round(carb);
  
  // Update log items summary
  const logItems = document.getElementById('logItems');
  logItems.innerHTML = day.foods.length ? 
    `<div class="badge">${day.foods.length} items logged</div>` : 
    `<div class="badge">No food logged today</div>`;
}

function removeFood(i){
  const today = new Date().toDateString();
  state.daysData[today].foods.splice(i,1);
  save();
  updateLog();
  updateDashboard();
}

document.getElementById('clearToday').onclick = ()=>{
  const today = new Date().toDateString();
  state.daysData[today] = {foods:[],water:0};
  save();
  updateLog();
  updateDashboard();
  updateWater();
};

// ====== Camera ======
let model, video, canvas, ctx;

document.getElementById('startCam').onclick = async ()=>{
  video = document.getElementById('vid');
  canvas = document.getElementById('frame');
  ctx = canvas.getContext('2d');
  
  try{
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    video.srcObject = stream;
    document.getElementById('startCam').classList.add('hidden');
    document.getElementById('stopCam').classList.remove('hidden');
    document.getElementById('snap').classList.remove('ghost');
    
    // Load model
    model = await mobilenet.load({version:2, alpha:0.5});
  }catch(e){
    alert('Camera error: '+e.message);
  }
};

document.getElementById('stopCam').onclick = ()=>{
  if(video.srcObject){
    video.srcObject.getTracks().forEach(t=>t.stop());
    document.getElementById('startCam').classList.remove('hidden');
    document.getElementById('stopCam').classList.add('hidden');
    document.getElementById('snap').classList.add('ghost');
  }
};

document.getElementById('snap').onclick = ()=>{
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video,0,0);
  canvas.classList.remove('hidden');
  video.classList.add('hidden');
};

document.getElementById('classify').onclick = async ()=>{
  if(!model || !canvas.width) return;
  const pred = await model.classify(canvas);
  const predDiv = document.getElementById('pred');
  predDiv.innerHTML = '';
  pred.forEach(p=>{
    const btn = document.createElement('button');
    btn.className = 'ghost';
    btn.textContent = `${p.className} (${Math.round(p.probability*100)}%)`;
    btn.onclick = ()=> document.getElementById('foodSearch').value = p.className;
    predDiv.appendChild(btn);
  });
};

// Portion estimation based on food size
document.getElementById('foodSize').onchange = function() {
  const size = this.value;
  let weight = 0;
  switch(size) {
    case 'small': weight = 50; break;
    case 'medium': weight = 150; break;
    case 'large': weight = 300; break;
    case 'bowl': weight = 200; break;
    case 'plate': weight = 400; break;
  }
  document.getElementById('estimatedWeight').value = weight;
  document.getElementById('portion').value = weight;
};

// Add to meal
document.getElementById('addMeal').onclick = ()=>{
  const name = document.getElementById('foodSearch').value;
  const grams = +document.getElementById('portion').value;
  const meal = document.getElementById('mealType').value;
  
  if(!name || !grams) return alert('Please enter food and portion');
  
  const today = new Date().toDateString();
  if(!state.daysData[today]) state.daysData[today] = {foods:[],water:0};
  state.daysData[today].foods.push({name,grams,meal});
  save();
  updateLog();
  updateDashboard();
  
  // Reset form
  document.getElementById('foodSearch').value = '';
  document.getElementById('portion').value = 150;
};

// ====== Make a Dish ======
document.getElementById('addIngredient').onclick = ()=>{
  const container = document.getElementById('dishIngredients');
  const div = document.createElement('div');
  div.className = 'dish-ingredient-grid';
  div.innerHTML = `
    <select class="ingredientSelect">
      <option value="">Select ingredient</option>
    </select>
    <input type="number" class="ingredientGrams" placeholder="Grams" value="100">
    <span class="small">Portion</span>
    <button class="removeIngredient danger">√ó</button>
  `;
  container.appendChild(div);
  
  // Update the select options for the new ingredient
  const select = div.querySelector('.ingredientSelect');
  FOODS.forEach(food => {
    const option = document.createElement('option');
    option.value = food.name;
    option.textContent = food.name;
    select.appendChild(option);
  });
  
  // Add remove functionality
  div.querySelector('.removeIngredient').onclick = ()=> div.remove();
};

// Calculate dish nutrition
document.getElementById('calculateDish').onclick = ()=>{
  const ingredients = document.querySelectorAll('.dish-ingredient-grid');
  let totalWeight = 0;
  let totalKcal = 0, totalProt = 0, totalFat = 0, totalCarb = 0;
  
  ingredients.forEach(ing => {
    const name = ing.querySelector('.ingredientSelect').value;
    const grams = +ing.querySelector('.ingredientGrams').value;
    
    if(name && grams){
      const food = FOODS.find(f=>f.name===name);
      if(food){
        const ratio = grams/100;
        totalWeight += grams;
        totalKcal += food.kcal * ratio;
        totalProt += food.prot * ratio;
        totalFat += food.fat * ratio;
        totalCarb += food.carb * ratio;
      }
    }
  });
  
  if(totalWeight === 0) return alert('Add ingredients first');
  
  // Calculate per 100g
  const ratio = 100/totalWeight;
  document.getElementById('dishKcal').textContent = Math.round(totalKcal * ratio);
  document.getElementById('dishProt').textContent = (totalProt * ratio).toFixed(1);
  document.getElementById('dishFat').textContent = (totalFat * ratio).toFixed(1);
  document.getElementById('dishCarb').textContent = (totalCarb * ratio).toFixed(1);
  
  document.getElementById('dishResults').classList.remove('hidden');
};

// Save dish
document.getElementById('saveDish').onclick = ()=>{
  const name = document.getElementById('dishName').value;
  if(!name) return alert('Enter dish name');
  
  const ingredients = [];
  document.querySelectorAll('.dish-ingredient-grid').forEach(ing => {
    const foodName = ing.querySelector('.ingredientSelect').value;
    const grams = +ing.querySelector('.ingredientGrams').value;
    if(foodName && grams) ingredients.push({name:foodName, grams});
  });
  
  if(ingredients.length === 0) return alert('Add ingredients first');
  
  // Calculate nutrition
  let totalWeight = 0;
  let totalKcal = 0, totalProt = 0, totalFat = 0, totalCarb = 0;
  
  ingredients.forEach(ing => {
    const food = FOODS.find(f=>f.name===ing.name);
    if(food){
      const ratio = ing.grams/100;
      totalWeight += ing.grams;
      totalKcal += food.kcal * ratio;
      totalProt += food.prot * ratio;
      totalFat += food.fat * ratio;
      totalCarb += food.carb * ratio;
    }
  });
  
  const ratio = 100/totalWeight;
  const dish = {
    name,
    ingredients,
    nutrition: {
      kcal: Math.round(totalKcal * ratio),
      prot: +(totalProt * ratio).toFixed(1),
      fat: +(totalFat * ratio).toFixed(1),
      carb: +(totalCarb * ratio).toFixed(1)
    }
  };
  
  state.dishes.push(dish);
  save();
  updateSavedDishes();
  alert('Dish saved!');
};

function updateSavedDishes(){
  const container = document.getElementById('savedDishes');
  container.innerHTML = '';
  
  state.dishes.forEach((dish, i) => {
    const div = document.createElement('div');
    div.className = 'dish-saved';
    div.innerHTML = `
      <h4>${dish.name}</h4>
      <div class="small">Ingredients: ${dish.ingredients.map(i=>`${i.name} (${i.grams}g)`).join(', ')}</div>
      <div class="row">
        <div class="col"><strong>Calories:</strong> ${dish.nutrition.kcal}</div>
        <div class="col"><strong>Protein:</strong> ${dish.nutrition.prot}g</div>
        <div class="col"><strong>Fat:</strong> ${dish.nutrition.fat}g</div>
        <div class="col"><strong>Carbs:</strong> ${dish.nutrition.carb}g</div>
      </div>
      <div class="toolbar">
        <button class="ok" onclick="addDishToLog(${i})">Add to Log</button>
        <button class="danger" onclick="deleteDish(${i})">Delete</button>
      </div>
    `;
    container.appendChild(div);
  });
}

function addDishToLog(i){
  const dish = state.dishes[i];
  const meal = prompt('Which meal? (Breakfast, Lunch, Dinner, Snack)', 'Lunch');
  if(!meal) return;
  
  const grams = +prompt('Portion size in grams?', '200');
  if(!grams) return;
  
  const ratio = grams/100;
  const today = new Date().toDateString();
  if(!state.daysData[today]) state.daysData[today] = {foods:[],water:0};
  
  state.daysData[today].foods.push({
    name: dish.name,
    grams: grams,
    meal: meal
  });
  
  save();
  updateLog();
  updateDashboard();
  alert(`${dish.name} added to ${meal}`);
}

function deleteDish(i){
  if(confirm('Delete this dish?')){
    state.dishes.splice(i,1);
    save();
    updateSavedDishes();
  }
}

// ====== Water ======
function updateWater(){
  const today = new Date().toDateString();
  const day = state.daysData[today] || {foods:[],water:0};
  const target = +(state.waterTarget || 2500);
  const cupSize = +(state.cupSize || 250);
  
  document.getElementById('waterTarget').value = target;
  document.getElementById('cupSize').value = cupSize;
  
  const progress = (day.water / target) * 100;
  document.getElementById('waterProg').value = progress;
  document.getElementById('waterProgTxt').textContent = `${day.water} / ${target} ml`;
  
  // Update cups
  const cupsContainer = document.getElementById('cups');
  cupsContainer.innerHTML = '';
  const cups = Math.ceil(target / cupSize);
  const filledCups = Math.floor(day.water / cupSize);
  
  for(let i=0; i<cups; i++){
    const cup = document.createElement('div');
    cup.className = 'cup' + (i < filledCups ? ' fill' : '');
    cup.onclick = ()=> drinkWater(cupSize);
    cupsContainer.appendChild(cup);
  }
}

function drinkWater(amount){
  const today = new Date().toDateString();
  if(!state.daysData[today]) state.daysData[today] = {foods:[],water:0};
  state.daysData[today].water += amount;
  save();
  updateWater();
}

document.getElementById('saveWater').onclick = ()=>{
  state.waterTarget = +document.getElementById('waterTarget').value;
  state.cupSize = +document.getElementById('cupSize').value;
  save();
  updateWater();
};

document.getElementById('drink').onclick = ()=> drinkWater(+(state.cupSize || 250));
document.getElementById('resetWater').onclick = ()=>{
  const today = new Date().toDateString();
  if(state.daysData[today]) state.daysData[today].water = 0;
  save();
  updateWater();
};

// ====== Goals ======
document.getElementById('saveGoals').onclick = ()=>{
  state.goals = {
    kcal: +document.getElementById('g_kcal').value,
    prot: +document.getElementById('g_prot').value,
    fat: +document.getElementById('g_fat').value,
    carb: +document.getElementById('g_carb').value
  };
  save();
  alert('Goals saved!');
  updateDashboard();
};

document.getElementById('recalcGoals').onclick = ()=>{
  state.goals = calcGoals();
  save();
  updateGoalsForm();
  updateDashboard();
};

function updateGoalsForm(){
  if(state.goals){
    document.getElementById('g_kcal').value = state.goals.kcal;
    document.getElementById('g_prot').value = state.goals.prot;
    document.getElementById('g_fat').value = state.goals.fat;
    document.getElementById('g_carb').value = state.goals.carb;
  }
}

// Custom Goals
document.getElementById('addCustomGoal').onclick = ()=>{
  const text = document.getElementById('newCustomGoal').value.trim();
  if(!text) return;
  
  const today = new Date().toDateString();
  if(!state.customGoals[today]) state.customGoals[today] = [];
  state.customGoals[today].push({text, completed: false});
  save();
  
  document.getElementById('newCustomGoal').value = '';
  updateCustomGoals();
};

function updateCustomGoals(){
  const today = new Date().toDateString();
  const goals = state.customGoals[today] || [];
  const container = document.getElementById('customGoalsList');
  container.innerHTML = '';
  
  goals.forEach((goal, i) => {
    const div = document.createElement('div');
    div.className = 'custom-goal-item';
    div.innerHTML = `
      <div class="custom-goal-checkbox ${goal.completed ? 'checked' : ''}" onclick="toggleCustomGoal(${i})"></div>
      <div class="custom-goal-text ${goal.completed ? 'goal-completed' : ''}">${goal.text}</div>
      <button class="custom-goal-remove" onclick="removeCustomGoal(${i})">√ó</button>
    `;
    container.appendChild(div);
  });
}

function toggleCustomGoal(i){
  const today = new Date().toDateString();
  if(state.customGoals[today] && state.customGoals[today][i]){
    state.customGoals[today][i].completed = !state.customGoals[today][i].completed;
    save();
    updateCustomGoals();
  }
}

function removeCustomGoal(i){
  const today = new Date().toDateString();
  if(state.customGoals[today] && state.customGoals[today][i]){
    state.customGoals[today].splice(i,1);
    save();
    updateCustomGoals();
  }
}

// ====== Profile ======
function updateProfile(){
  const {sex,age,height,weight,days,goal,goals} = state;
  const summary = document.getElementById('profSummary');
  summary.innerHTML = `
    <div class="row">
      <div class="col"><strong>Sex:</strong> ${sex}</div>
      <div class="col"><strong>Age:</strong> ${age}</div>
      <div class="col"><strong>Height:</strong> ${height} cm</div>
      <div class="col"><strong>Weight:</strong> ${weight} kg</div>
    </div>
    <div class="row">
      <div class="col"><strong>Workout days:</strong> ${days}/week</div>
      <div class="col"><strong>Goal:</strong> ${goal}</div>
    </div>
    <div class="row">
      <div class="col"><strong>Calories:</strong> ${goals.kcal}</div>
      <div class="col"><strong>Protein:</strong> ${goals.prot}g</div>
      <div class="col"><strong>Fat:</strong> ${goals.fat}g</div>
      <div class="col"><strong>Carbs:</strong> ${goals.carb}g</div>
    </div>
  `;
}

document.getElementById('restart').onclick = ()=>{
  if(confirm('Reset all data and restart wizard?')){
    localStorage.removeItem(SKEY);
    location.reload();
  }
};

// ====== Workout Section ======

// Exercise database
const EXERCISES = {
  chest: [
    "Barbell Bench Press", "Incline Bench Press", "Dumbbell Bench Press", 
    "Incline Dumbbell Bench Press", "Decline Bench Press", "Weighted Dips", 
    "Push-Ups (weighted or banded)", "Cable Chest Fly (flat)", 
    "Cable Chest Fly (low to high)", "Machine Chest Press", "Pec Deck Machine", "Floor Press"
  ],
  back: [
    "Barbell Row", "Dumbbell Row", "Chest-Supported Row", "Seal Row", 
    "T-Bar Row", "Meadows Row", "Cable Row (close grip)", "Cable Row (wide grip)", 
    "Lat Pulldown (wide grip)", "Lat Pulldown (neutral grip)", "Machine High Row", 
    "Inverted Row", "Shrugs (barbell or dumbbell)", "Seal Row with Pause"
  ],
  shoulders: [
    "Overhead Barbell Press", "Dumbbell Shoulder Press", "Arnold Press", 
    "Z Press (seated barbell press on floor)", "Push Press", "Dumbbell Lateral Raise", 
    "Cable Lateral Raise", "Machine Lateral Raise", "Upright Row (EZ bar, wide grip)", 
    "Dumbbell Front Raise", "Cable Front Raise", "Rear Delt Fly (DB)", 
    "Rear Delt Fly (cable)", "Reverse Pec Deck Machine", "Face Pulls"
  ],
  arms: [
    "Barbell Curl", "EZ Bar Curl", "Dumbbell Curl (alternating)", 
    "Incline Dumbbell Curl", "Concentration Curl", "Cable Curl (straight bar)", 
    "Rope Hammer Curl", "Zottman Curl", "Preacher Curl (EZ or DB)", 
    "Machine Curl", "Skull Crushers (EZ bar)", "Overhead Triceps Extension (DB)", 
    "Cable Rope Pushdown", "Straight Bar Pushdown", "Overhead Rope Extension", 
    "Dumbbell Kickback", "Close Grip Bench Press", "JM Press", 
    "Machine Triceps Extension", "Barbell Wrist Curl", "Reverse Curl (EZ bar)", 
    "Hammer Curl", "Farmer's Carry", "Plate Pinch Hold"
  ],
  legs: [
    "Back Squat", "Front Squat", "Safety Bar Squat", 
    "Hack Squat (machine or barbell)", "Bulgarian Split Squat", 
    "Walking Lunges", "Step-Ups", "Leg Press", "Sissy Squat", 
    "Romanian Deadlift (RDL)", "Stiff-Leg Deadlift", "Good Morning", 
    "Glute-Ham Raise", "Nordic Hamstring Curl", "Lying Leg Curl (machine)", 
    "Seated Leg Curl", "Hip Thrust", "Barbell Glute Bridge", 
    "Cable Kickback", "Reverse Hyperextension", "Step-Ups (glute emphasis)", 
    "Standing Calf Raise", "Seated Calf Raise", "Donkey Calf Raise", 
    "Single-Leg Calf Raise", "Leg Press Calf Extension"
  ],
  core: [
    "Hanging Leg Raise", "Weighted Plank", "Cable Crunch", 
    "Ab Wheel Rollout", "Side Plank (weighted)", "Dragon Flag", 
    "Decline Sit-Up (weighted)", "Pallof Press", 
    "Russian Twist (weighted)", "Landmine Oblique Twist"
  ]
};

// Pre-made workout plans
const WORKOUT_PLANS = {
  ppl: {
    name: "Push/Pull/Legs (PPL)",
    days: [
      {
        name: "Day 1 - Push",
        exercises: [
          { name: "Incline Bench Press", sets: 4, reps: "6-8" },
          { name: "Overhead Press", sets: 3, reps: "6-8" },
          { name: "Flat Dumbbell Press", sets: 3, reps: "8-10" },
          { name: "Dumbbell Lateral Raise", sets: 4, reps: "12-15" },
          { name: "Cable Triceps Pushdown", sets: 3, reps: "12-15" }
        ]
      },
      {
        name: "Day 2 - Pull",
        exercises: [
          { name: "Barbell Row", sets: 4, reps: "6-8" },
          { name: "Chest-Supported Row", sets: 3, reps: "8-10" },
          { name: "Lat Pulldown", sets: 4, reps: "8-12" },
          { name: "Face Pull", sets: 3, reps: "12-15" },
          { name: "Incline Dumbbell Curl", sets: 3, reps: "10-12" }
        ]
      },
      {
        name: "Day 3 - Legs",
        exercises: [
          { name: "Back Squat", sets: 4, reps: "6-8" },
          { name: "Romanian Deadlift", sets: 3, reps: "8-10" },
          { name: "Walking Lunge", sets: 3, reps: "10/leg" },
          { name: "Leg Press", sets: 3, reps: "10-12" },
          { name: "Standing Calf Raise", sets: 4, reps: "12-15" }
        ]
      }
    ]
  },
  upperLower: {
    name: "Upper/Lower Split",
    days: [
      {
        name: "Day 1 - Upper (Strength)",
        exercises: [
          { name: "Incline Bench Press", sets: 4, reps: "6" },
          { name: "Barbell Row", sets: 4, reps: "6-8" },
          { name: "Overhead Press", sets: 3, reps: "6-8" },
          { name: "Lat Pulldown", sets: 3, reps: "8-10" },
          { name: "EZ Curl + Skull Crusher (superset)", sets: 3, reps: "10-12" }
        ]
      },
      {
        name: "Day 2 - Lower (Strength)",
        exercises: [
          { name: "Back Squat", sets: 4, reps: "6" },
          { name: "Bulgarian Split Squat", sets: 3, reps: "10/leg" },
          { name: "Hip Thrust", sets: 3, reps: "8-10" },
          { name: "Calf Raise", sets: 4, reps: "12-15" },
          { name: "Weighted Plank", sets: 3, reps: "45 sec" }
        ]
      },
      {
        name: "Day 3 - Upper (Hypertrophy)",
        exercises: [
          { name: "Flat Dumbbell Press", sets: 4, reps: "8-10" },
          { name: "Chest-Supported Row", sets: 4, reps: "8-10" },
          { name: "DB Shoulder Press", sets: 3, reps: "10" },
          { name: "Lat Pulldown", sets: 3, reps: "10-12" },
          { name: "Lateral Raise", sets: 3, reps: "12-15" },
          { name: "DB Curl + Rope Pushdown", sets: 3, reps: "12" }
        ]
      },
      {
        name: "Day 4 - Lower (Hypertrophy)",
        exercises: [
          { name: "Front Squat", sets: 4, reps: "8" },
          { name: "Walking Lunge", sets: 3, reps: "12/leg" },
          { name: "Leg Curl", sets: 3, reps: "12-15" },
          { name: "Hip Thrust", sets: 3, reps: "8-10" },
          { name: "Seated Calf Raise", sets: 4, reps: "15" },
          { name: "Hanging Leg Raise", sets: 3, reps: "12-15" }
        ]
      }
    ]
  }
};

// Workout UI Functions
function showWorkoutSection(section) {
  document.getElementById('workoutPlans').classList.add('hidden');
  document.getElementById('customWorkoutPlan').classList.add('hidden');
  document.getElementById('exerciseLibrary').classList.add('hidden');
  document.getElementById('workoutHistory').classList.add('hidden');
  
  document.getElementById(section).classList.remove('hidden');
}

document.getElementById('showPlans').onclick = () => showWorkoutSection('workoutPlans');
document.getElementById('showCustom').onclick = () => {
  showWorkoutSection('customWorkoutPlan');
  updateCustomPlanDays();
};
document.getElementById('showExercises').onclick = () => {
  showWorkoutSection('exerciseLibrary');
  populateExerciseLibrary();
};
document.getElementById('showHistory').onclick = () => {
  showWorkoutSection('workoutHistory');
  updateWorkoutHistory();
};

// Select a pre-made workout plan
function selectWorkoutPlan(planId) {
  const plan = WORKOUT_PLANS[planId];
  if (!plan) return;
  
  // Save to user's workout plans
  if (!state.workoutPlans.find(p => p.id === planId)) {
    state.workoutPlans.push({
      id: planId,
      name: plan.name,
      days: JSON.parse(JSON.stringify(plan.days)) // Deep copy
    });
    save();
    updateWorkoutPlans();
  }
  
  alert(`Added ${plan.name} to your workout plans!`);
}

// Update custom plan days based on selection
function updateCustomPlanDays() {
  const days = +document.getElementById('customPlanDays').value;
  const container = document.getElementById('customPlanDaysContainer');
  container.innerHTML = '';
  
  for (let i = 1; i <= days; i++) {
    const dayDiv = document.createElement('div');
    dayDiv.className = 'workout-day';
    dayDiv.innerHTML = `
      <h4>Day ${i}</h4>
      <div class="toolbar">
        <input type="text" class="dayName" placeholder="Day ${i} Name (e.g., Push Day)" value="Day ${i}">
        <button class="ghost addExerciseBtn" data-day="${i}">+ Add Exercise</button>
      </div>
      <div class="dayExercises" id="day${i}Exercises"></div>
    `;
    container.appendChild(dayDiv);
    
    // Add exercise functionality
    dayDiv.querySelector('.addExerciseBtn').onclick = function() {
      addExerciseToDay(i);
    };
  }
}

// Add exercise to custom plan day
function addExerciseToDay(dayNum) {
  const container = document.getElementById(`day${dayNum}Exercises`);
  const exerciseDiv = document.createElement('div');
  exerciseDiv.className = 'custom-workout-exercise';
  exerciseDiv.innerHTML = `
    <select class="exerciseSelect">
      <option value="">Select Exercise</option>
    </select>
    <input type="number" class="exerciseSets" placeholder="Sets" value="3" min="1" max="10">
    <input type="text" class="exerciseReps" placeholder="Reps (e.g., 8-12)" value="8-12">
    <button class="danger removeExercise">√ó</button>
  `;
  
  // Populate exercise options
  const select = exerciseDiv.querySelector('.exerciseSelect');
  Object.values(EXERCISES).flat().forEach(exercise => {
    const option = document.createElement('option');
    option.value = exercise;
    option.textContent = exercise;
    select.appendChild(option);
  });
  
  // Remove exercise functionality
  exerciseDiv.querySelector('.removeExercise').onclick = function() {
    exerciseDiv.remove();
  };
  
  container.appendChild(exerciseDiv);
}

// Save custom workout plan
document.getElementById('saveCustomPlan').onclick = function() {
  const planName = document.getElementById('customPlanName').value.trim();
  if (!planName) return alert('Please enter a plan name');
  
  const days = +document.getElementById('customPlanDays').value;
  const planDays = [];
  
  for (let i = 1; i <= days; i++) {
    const dayName = document.querySelector(`#day${i}Exercises`).closest('.workout-day').querySelector('.dayName').value;
    const exercises = [];
    
    document.querySelectorAll(`#day${i}Exercises .custom-workout-exercise`).forEach(exDiv => {
      const name = exDiv.querySelector('.exerciseSelect').value;
      const sets = +exDiv.querySelector('.exerciseSets').value;
      const reps = exDiv.querySelector('.exerciseReps').value;
      
      if (name && sets && reps) {
        exercises.push({ name, sets, reps });
      }
    });
    
    if (exercises.length > 0) {
      planDays.push({
        name: dayName || `Day ${i}`,
        exercises
      });
    }
  }
  
  if (planDays.length === 0) return alert('Add at least one exercise to your plan');
  
  const planId = 'custom_' + Date.now();
  state.workoutPlans.push({
    id: planId,
    name: planName,
    days: planDays
  });
  
  save();
  updateWorkoutPlans();
  alert('Custom workout plan saved!');
  
  // Reset form
  document.getElementById('customPlanName').value = '';
  updateCustomPlanDays();
};

// Populate exercise library
function populateExerciseLibrary() {
  Object.keys(EXERCISES).forEach(category => {
    const container = document.getElementById(category + 'Exercises');
    if (container) {
      container.innerHTML = '';
      EXERCISES[category].forEach(exercise => {
        const div = document.createElement('div');
        div.className = 'exercise-item';
        div.textContent = exercise;
        div.onclick = () => {
          // Copy to clipboard or add to custom plan
          navigator.clipboard.writeText(exercise).then(() => {
            alert(`Copied "${exercise}" to clipboard`);
          });
        };
        container.appendChild(div);
      });
    }
  });
}

// Update workout plans list
function updateWorkoutPlans() {
  const container = document.getElementById('workoutPlansList');
  container.innerHTML = '';
  
  state.workoutPlans.forEach((plan, planIndex) => {
    const planDiv = document.createElement('div');
    planDiv.className = 'workout-plan';
    planDiv.innerHTML = `<h3>${plan.name}</h3>`;
    
    plan.days.forEach((day, dayIndex) => {
      const dayDiv = document.createElement('div');
      dayDiv.className = 'workout-day';
      dayDiv.innerHTML = `<h4>${day.name}</h4>`;
      
      day.exercises.forEach(exercise => {
        const exDiv = document.createElement('div');
        exDiv.className = 'workout-exercise';
        exDiv.innerHTML = `
          <strong>${exercise.name}</strong> - ${exercise.sets} sets √ó ${exercise.reps}
        `;
        dayDiv.appendChild(exDiv);
      });
      
      const startBtn = document.createElement('button');
      startBtn.className = 'ok';
      startBtn.textContent = 'Start Workout';
      startBtn.onclick = () => startWorkout(planIndex, dayIndex);
      dayDiv.appendChild(startBtn);
      
      planDiv.appendChild(dayDiv);
    });
    
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'danger';
    deleteBtn.textContent = 'Delete Plan';
    deleteBtn.onclick = () => deleteWorkoutPlan(planIndex);
    planDiv.appendChild(deleteBtn);
    
    container.appendChild(planDiv);
  });
}

// Start a workout
function startWorkout(planIndex, dayIndex) {
  const plan = state.workoutPlans[planIndex];
  const day = plan.days[dayIndex];
  
  // Set active workout
  state.activeWorkout = {
    planIndex,
    dayIndex,
    planName: plan.name,
    dayName: day.name,
    exercises: day.exercises.map(ex => ({
      name: ex.name,
      sets: ex.sets,
      reps: ex.reps,
      completedSets: Array(ex.sets).fill().map(() => ({ weight: '', reps: '' }))
    })),
    startTime: new Date().toISOString()
  };
  
  save();
  showActiveWorkout();
}

// Show active workout (full page)
function showActiveWorkout() {
  if (!state.activeWorkout) return;
  
  // Hide main container and show active workout page
  document.querySelector('.container').classList.add('hidden');
  document.getElementById('activeWorkoutPage').classList.remove('hidden');
  
  const workout = state.activeWorkout;
  document.getElementById('activeWorkoutName').textContent = `${workout.planName} - ${workout.dayName}`;
  
  const container = document.getElementById('activeWorkoutExercises');
  container.innerHTML = '';
  
  workout.exercises.forEach((exercise, exIndex) => {
    const exDiv = document.createElement('div');
    exDiv.className = 'workout-day';
    exDiv.innerHTML = `<h4>${exercise.name}</h4>`;
    
    // Add set headers
    const setHeader = document.createElement('div');
    setHeader.className = 'workout-set-header';
    setHeader.innerHTML = `
      <span>Set</span>
      <span>Weight (kg)</span>
      <span>Reps</span>
      <span>Completed</span>
    `;
    exDiv.appendChild(setHeader);
    
    // Add sets with proper spacing
    for (let i = 0; i < exercise.sets; i++) {
      const setDiv = document.createElement('div');
      setDiv.className = 'workout-set';
      setDiv.innerHTML = `
        <span>${i + 1}</span>
        <input type="number" placeholder="0" value="${exercise.completedSets[i].weight}" 
               onchange="updateActiveWorkoutSet(${exIndex}, ${i}, 'weight', this.value)">
        <input type="number" placeholder="0" value="${exercise.completedSets[i].reps}" 
               onchange="updateActiveWorkoutSet(${exIndex}, ${i}, 'reps', this.value)">
        <input type="checkbox" ${exercise.completedSets[i].weight && exercise.completedSets[i].reps ? 'checked' : ''} 
               onchange="toggleSetCompletion(${exIndex}, ${i}, this.checked)">
      `;
      exDiv.appendChild(setDiv);
    }
    
    container.appendChild(exDiv);
  });
}

// Update active workout set
function updateActiveWorkoutSet(exIndex, setIndex, field, value) {
  if (state.activeWorkout) {
    state.activeWorkout.exercises[exIndex].completedSets[setIndex][field] = value;
    save();
  }
}

// Toggle set completion
function toggleSetCompletion(exIndex, setIndex, completed) {
  if (state.activeWorkout) {
    const set = state.activeWorkout.exercises[exIndex].completedSets[setIndex];
    if (completed && (!set.weight || !set.reps)) {
      alert('Please enter both weight and reps before marking as completed');
      // Uncheck the checkbox
      event.target.checked = false;
      return;
    }
    save();
  }
}

// Finish workout
document.getElementById('finishWorkout').onclick = function() {
  if (!state.activeWorkout) return;
  
  // Save to workout history
  const workout = {
    ...state.activeWorkout,
    endTime: new Date().toISOString(),
    completed: true
  };
  
  state.workoutHistory.unshift(workout);
  
  // Clear active workout
  state.activeWorkout = null;
  
  save();
  
  // Return to main app
  document.getElementById('activeWorkoutPage').classList.add('hidden');
  document.querySelector('.container').classList.remove('hidden');
  
  alert('Workout completed!');
  updateWorkoutHistory();
};

// Cancel workout
document.getElementById('cancelWorkout').onclick = function() {
  if (confirm('Cancel this workout? Progress will be lost.')) {
    state.activeWorkout = null;
    save();
    
    // Return to main app
    document.getElementById('activeWorkoutPage').classList.add('hidden');
    document.querySelector('.container').classList.remove('hidden');
  }
};

// Delete workout plan
function deleteWorkoutPlan(planIndex) {
  if (confirm('Delete this workout plan?')) {
    state.workoutPlans.splice(planIndex, 1);
    save();
    updateWorkoutPlans();
  }
}

// Update workout history
function updateWorkoutHistory() {
  const container = document.getElementById('workoutHistoryList');
  container.innerHTML = '';
  
  state.workoutHistory.forEach((workout, index) => {
    const div = document.createElement('div');
    div.className = 'workout-history-item';
    
    const startDate = new Date(workout.startTime).toLocaleDateString();
    const duration = workout.endTime ? 
      Math.round((new Date(workout.endTime) - new Date(workout.startTime)) / 60000) + ' min' : 
      'Incomplete';
    
    div.innerHTML = `
      <h4>${workout.planName} - ${workout.dayName}</h4>
      <div class="small">${startDate} ‚Ä¢ ${duration}</div>
      <button class="ghost" onclick="viewWorkoutDetails(${index})">View Details</button>
      <button class="danger" onclick="deleteWorkoutHistory(${index})">Delete</button>
    `;
    
    container.appendChild(div);
  });
}

// View workout details
function viewWorkoutDetails(index) {
  const workout = state.workoutHistory[index];
  let details = `${workout.planName} - ${workout.dayName}\n\n`;
  
  workout.exercises.forEach(exercise => {
    details += `${exercise.name}:\n`;
    exercise.completedSets.forEach((set, i) => {
      if (set.weight || set.reps) {
        details += `  Set ${i + 1}: ${set.weight} kg √ó ${set.reps} reps\n`;
      }
    });
    details += '\n';
  });
  
  alert(details);
}

// Delete workout history
function deleteWorkoutHistory(index) {
  if (confirm('Delete this workout from history?')) {
    state.workoutHistory.splice(index, 1);
    save();
    updateWorkoutHistory();
  }
}

// ====== Navigation Event Listeners ======
document.querySelectorAll('#nav button').forEach(button => {
  button.addEventListener('click', function() {
    showTab(this.dataset.tab);
  });
});

// Dashboard buttons
document.getElementById('toCamera').onclick = ()=> showTab('camera');
document.getElementById('toLog').onclick = ()=> showTab('log');

// ====== Init ======
function init(){
  fillLangSelects();
  
  // Check if user has completed onboarding
  if(state.onboarded){
    setLang(state.lang || 'ar');
    // Hide wizard, show main UI
    document.getElementById('wizard').classList.add('hidden');
    updateGoalsForm();
    updateProfile();
    updateDashboard();
    updateFoodLists();
  } else {
    setLang('ar');
    // Show wizard for new users
    document.getElementById('wizard').classList.remove('hidden');
    document.getElementById('home').classList.add('hidden');
    markSteps(true,false,false);
  }
}

// Initialize the app
init();
</script>
</body>
</html>