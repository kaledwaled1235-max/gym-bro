<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Calorie & Macro Tracker (MVP) — Monochrome</title>
<style>
:root{
  /* Monochrome palette */
  --bg:#ffffff; --card:#ffffff; --ink:#000000; --sub:#444444;
  --brand:#000000; --ok:#000000; --warn:#000000; --danger:#000000;
  --muted:#d0d0d0;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:#fff; color:var(--ink);
}
.container{max-width:980px;margin:0 auto;padding:16px}
.card{
  background:var(--card); border:1px solid var(--muted);
  box-shadow:none; border-radius:18px; padding:16px; margin:12px 0;
}
h1,h2,h3{margin:8px 0}
h1{font-size:clamp(22px,3.8vw,30px)}
h2{font-size:clamp(18px,3.2vw,24px)}
.sub{color:var(--sub)}
.row{display:flex; gap:12px; flex-wrap:wrap}
.col{flex:1 1 260px}
label{display:block; font-weight:600; margin:6px 0}
input,select,button,textarea{
  width:100%; padding:12px; border-radius:12px; border:1px solid var(--muted);
  font-size:16px; background:#fff; color:var(--ink);
}
button{background:var(--brand); color:#fff; border:1px solid #000; cursor:pointer; font-weight:700}
button.ghost{background:#fff; color:#000}
button.warn{background:#fff; color:#000}
button.ok{background:#000; color:#fff}
button.danger{background:#000; color:#fff}
button:active{transform:scale(.99)}
.toolbar{display:flex; gap:8px; flex-wrap:wrap}
nav{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px}
nav button{flex:1 1 120px}
.badge{display:inline-block; padding:4px 10px; border-radius:999px; background:#f4f4f4; color:#000}
.small{font-size:13px; color:var(--sub)}
hr{border:none; border-top:1px dashed var(--muted); margin:12px 0}
table{width:100%; border-collapse:collapse}
th,td{border-bottom:1px solid #e5e7eb; padding:8px; text-align:center}
tfoot td{font-weight:800}
.kpi{display:flex; gap:10px; flex-wrap:wrap}
.kpi .card{flex:1 1 200px; text-align:center}
.center{text-align:center}
.hidden{display:none}
.flex{display:flex; gap:8px; align-items:center}
.flex-col{display:flex; gap:8px; flex-direction:column}
progress{width:100%; height:16px}
.tag{display:inline-block;padding:2px 8px;border-radius:8px;background:#eee;margin:2px;font-size:12px;border:1px solid #ccc}
.meal-item{display:flex;gap:8px;align-items:center;justify-content:space-between;border:1px solid #e5e7eb;padding:8px;border-radius:12px}
.meal-item strong{flex:1}
.meal-item input{width:90px}
footer{padding:24px 0;color:#666;text-align:center}
/* Camera */
.camera{background:#fff;color:#000;border-radius:16px;padding:12px;border:1px solid #dcdcdc}
video,canvas{width:100%;border-radius:12px;background:#000}
.pred{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
/* Wizard steps */
.stepper{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.step{flex:1;height:6px;background:#e2e2e2;border-radius:99px;position:relative}
.step.done{background:#9e9e9e}
.step.active{background:#000}
/* Water tracker */
.cups{display:flex;gap:6px;flex-wrap:wrap}
.cup{width:44px;height:60px;border:2px solid #000;border-radius:10px;position:relative;overflow:hidden;cursor:pointer;background:#fff}
.cup.fill::after{content:"";position:absolute;bottom:0;left:0;width:100%;height:70%;background:#000}
/* Utility */
.lang-switch{min-width:180px}
/* Custom goals - UPDATED */
.custom-goal-item{display:flex; gap:12px; align-items:center; padding:12px; border:1px solid #e5e7eb; border-radius:12px; margin-bottom:8px; background:#fafafa}
.custom-goal-text{flex:1; font-size:16px; font-weight:bold} /* Added font-weight:bold */
.custom-goal-checkbox{width:24px; height:24px; border:2px solid #000; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center}
.custom-goal-checkbox.checked{background:#000; color:#fff}
.custom-goal-checkbox.checked::after{content:"✓"; font-size:16px; font-weight:bold}
.custom-goal-remove{background:transparent; border:none; color:#666; cursor:pointer; font-size:18px}
.goal-completed{text-decoration:line-through; opacity:0.6}
/* Make a Dish - UPDATED */
.dish-builder{background:#f9f9f9; padding:16px; border-radius:12px; margin:12px 0}
.dish-ingredient{display:flex; gap:8px; align-items:center; margin-bottom:8px; padding:8px; background:white; border-radius:8px}
.dish-ingredient select,.dish-ingredient input{flex:1}
.dish-saved{background:#f0f0f0; padding:12px; border-radius:8px; margin:8px 0}
.dish-saved h4{margin:0 0 8px 0}
/* Added space for portion in Make a Dish section */
.dish-ingredient-grid {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr auto;
  gap: 8px;
  align-items: center;
  margin-bottom: 8px;
  padding: 8px;
  background: white;
  border-radius: 8px;
}
.dish-ingredient-grid select,
.dish-ingredient-grid input {
  width: 100%;
}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="row" style="align-items:center">
      <div class="col" style="flex:1 1 auto">
        <h1 id="appTitle">AI Calorie & Macro Tracker</h1>
        <div class="small" id="subtitle">MVP — on‑device mock AI + manual adjust. Data saved locally.</div>
      </div>
      <div class="col" style="max-width:260px">
        <label id="langLabel">Language</label>
        <select id="langSelect" class="lang-switch"></select>
      </div>
    </div>
  </div>

  <nav id="nav" class="card hidden">
    <button data-tab="home">Home</button>
    <button data-tab="goals">Daily Goals</button>
    <button data-tab="camera">Camera</button>
    <button data-tab="log">Food Log</button>
    <button data-tab="dishes">Make a Dish</button>
    <button data-tab="water">Water</button>
    <button data-tab="profile">Profile</button>
    <button data-tab="about">About</button>
  </nav>

  <!-- Onboarding Wizard -->
  <div id="wizard" class="card">
    <div class="stepper">
      <div class="step active" id="s1"></div>
      <div class="step" id="s2"></div>
      <div class="step" id="s3"></div>
    </div>
    <div id="step1">
      <h2 id="wTitle">Choose Language</h2>
      <div class="row">
        <div class="col">
          <label id="wLangLabel">Language</label>
          <select id="wLangSelect"></select>
        </div>
      </div>
      <div class="toolbar">
        <button id="next1">Next</button>
      </div>
    </div>

    <div id="step2" class="hidden">
      <h2>Profile</h2>
      <div class="row">
        <div class="col">
          <label>Sex</label>
          <select id="sex">
            <option value="male">Male</option>
            <option value="female">Female</option>
          </select>
        </div>
        <div class="col">
          <label>Age (years)</label>
          <input id="age" type="number" min="8" max="100" value="30">
        </div>
        <div class="col">
          <label>Height (cm)</label>
          <input id="height" type="number" min="100" max="230" value="170">
        </div>
        <div class="col">
          <label>Weight (kg)</label>
          <input id="weight" type="number" min="30" max="200" value="70">
        </div>
      </div>
      <div class="toolbar">
        <button class="ghost" id="back2">Back</button>
        <button id="next2">Next</button>
      </div>
    </div>

    <div id="step3" class="hidden">
      <h2>Activity</h2>
      <div class="row">
        <div class="col">
          <label>Workout days/week</label>
          <input id="days" type="number" min="0" max="7" value="3">
        </div>
        <div class="col">
          <label>Goal</label>
          <select id="goal">
            <option value="maintain">Maintain</option>
            <option value="cut">Cut (-15%)</option>
            <option value="bulk">Bulk (+10%)</option>
          </select>
        </div>
      </div>
      <div class="toolbar">
        <button class="ghost" id="back3">Back</button>
        <button id="finish">Finish</button>
      </div>
    </div>
  </div>

  <!-- Home / Dashboard -->
  <div id="home" class="card hidden">
    <h2 id="dashTitle">Dashboard</h2>
    <div class="kpi">
      <div class="card">
        <div class="small" data-i18n="calToday">Calories Today</div>
        <div id="kcalToday" style="font-size:28px;font-weight:800">0</div>
        <div class="small">Target: <span id="kcalTarget">0</span></div>
        <progress id="kcalProg" max="100" value="0"></progress>
      </div>
      <div class="card">
        <div class="small">Protein (g)</div>
        <div id="protToday" style="font-size:28px;font-weight:800">0</div>
        <div class="small">Target: <span id="protTarget">0</span></div>
        <progress id="protProg" max="100" value="0"></progress>
      </div>
      <div class="card">
        <div class="small">Fat (g)</div>
        <div id="fatToday" style="font-size:28px;font-weight:800">0</div>
        <div class="small">Target: <span id="fatTarget">0</span></div>
        <progress id="fatProg" max="100" value="0"></progress>
      </div>
      <div class="card">
        <div class="small">Carbs (g)</div>
        <div id="carbToday" style="font-size:28px;font-weight:800">0</div>
        <div class="small">Target: <span id="carbTarget">0</span></div>
        <progress id="carbProg" max="100" value="0"></progress>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <div class="badge">Streak: <span id="streak">0</span> 🔥</div>
      </div>
      <div class="col center">
        <button id="toCamera">Open Camera</button>
      </div>
      <div class="col center">
        <button class="ghost" id="toLog">Open Food Log</button>
      </div>
    </div>
  </div>

  <!-- Goals -->
  <div id="goals" class="card hidden">
    <h2>Daily Goals</h2>
    <div class="row">
      <div class="col"><label>Calories</label><input id="g_kcal" type="number"></div>
      <div class="col"><label>Protein (g)</label><input id="g_prot" type="number"></div>
      <div class="col"><label>Fat (g)</label><input id="g_fat" type="number"></div>
      <div class="col"><label>Carbs (g)</label><input id="g_carb" type="number"></div>
    </div>
    <div class="toolbar">
      <button id="saveGoals" class="ok">Save</button>
      <button id="recalcGoals" class="ghost">Recalculate from Profile</button>
    </div>
    
    <hr>
    
    <h3>Custom Daily Goals</h3>
    <div class="toolbar">
      <input type="text" id="newCustomGoal" placeholder="Add a custom goal (e.g., Walk 10k steps, Drink 2L water)">
      <button id="addCustomGoal" class="ok">Add Goal</button>
    </div>
    <div id="customGoalsList"></div>
  </div>

  <!-- Camera Page -->
  <div id="camera" class="card hidden">
    <h2>Camera (Beta)</h2>
    <div class="camera">
      <video id="vid" autoplay playsinline muted></video>
      <div class="toolbar">
        <button id="startCam">Start Camera</button>
        <button id="stopCam" class="ghost hidden">Stop Camera</button>
        <button id="snap" class="ghost">Capture</button>
        <button id="classify" class="ok">AI Guess</button>
      </div>
      <canvas id="frame" class="hidden"></canvas>
      <div class="pred" id="pred"></div>
    </div>
    <hr>
    <h3>Portion Estimation</h3>
    <div class="row">
      <div class="col">
        <label>Food Size</label>
        <select id="foodSize">
          <option value="small">Small (e.g., apple, egg)</option>
          <option value="medium">Medium (e.g., chicken breast, banana)</option>
          <option value="large">Large (e.g., steak, large fruit)</option>
          <option value="bowl">Bowl (e.g., rice, pasta, salad)</option>
          <option value="plate">Plate (e.g., full meal)</option>
        </select>
      </div>
      <div class="col">
        <label>Estimated Weight (g)</label>
        <input id="estimatedWeight" type="number" readonly>
        <div class="small">Based on food size selection</div>
      </div>
    </div>
    <hr>
    <h3>Add to Meal</h3>
    <div class="row">
      <div class="col">
        <label>Food</label>
        <input id="foodSearch" placeholder="Search or pick AI guess..." list="foodList">
        <datalist id="foodList"></datalist>
        <div class="small" id="foodHint">Examples: rice, chicken breast, apple, pizza</div>
      </div>
      <div class="col">
        <label>Portion (g)</label>
        <input id="portion" type="number" value="150">
      </div>
      <div class="col">
        <label>Meal</label>
        <select id="mealType">
          <option>Breakfast</option>
          <option>Lunch</option>
          <option>Dinner</option>
          <option>Snack</option>
        </select>
      </div>
    </div>
    <div class="toolbar">
      <button id="addMeal">Add to Log</button>
    </div>
  </div>

  <!-- Log -->
  <div id="log" class="card hidden">
    <h2>Food Log — <span id="logDate"></span></h2>
    <div id="logItems"></div>
    <hr>
    <table>
      <thead><tr><th>Meal</th><th>Food</th><th>g</th><th>kcal</th><th>P</th><th>F</th><th>C</th><th></th></tr></thead>
      <tbody id="logTable"></tbody>
      <tfoot><tr><td colspan="3">Totals</td><td id="tKcal">0</td><td id="tP">0</td><td id="tF">0</td><td id="tC">0</td><td></td></tr></tfoot>
    </table>
    <div class="toolbar">
      <button id="clearToday" class="danger">Clear Today</button>
    </div>
  </div>

  <!-- Make a Dish -->
  <div id="dishes" class="card hidden">
    <h2>Make a Dish</h2>
    <div class="dish-builder">
      <div class="row">
        <div class="col">
          <label>Dish Name</label>
          <input type="text" id="dishName" placeholder="Enter dish name (e.g., Chicken Salad)">
        </div>
      </div>
      
      <h4>Ingredients</h4>
      <div id="dishIngredients">
        <div class="dish-ingredient-grid">
          <select class="ingredientSelect">
            <option value="">Select ingredient</option>
          </select>
          <input type="number" class="ingredientGrams" placeholder="Grams" value="100">
          <span class="small">Portion</span>
          <button class="removeIngredient danger">×</button>
        </div>
      </div>
      
      <div class="toolbar">
        <button id="addIngredient" class="ghost">+ Add Ingredient</button>
        <button id="calculateDish" class="ok">Calculate Dish</button>
        <button id="saveDish" class="ok">Save Dish</button>
      </div>
      
      <div id="dishResults" class="hidden">
        <h4>Dish Nutrition (per 100g)</h4>
        <div class="row">
          <div class="col"><strong>Calories:</strong> <span id="dishKcal">0</span></div>
          <div class="col"><strong>Protein:</strong> <span id="dishProt">0</span>g</div>
          <div class="col"><strong>Fat:</strong> <span id="dishFat">0</span>g</div>
          <div class="col"><strong>Carbs:</strong> <span id="dishCarb">0</span>g</div>
        </div>
      </div>
    </div>
    
    <hr>
    
    <h3>Saved Dishes</h3>
    <div id="savedDishes"></div>
  </div>

  <!-- Water -->
  <div id="water" class="card hidden">
    <h2>Water Tracker</h2>
    <div class="row">
      <div class="col">
        <label>Daily target (ml)</label>
        <input id="waterTarget" type="number" value="2500">
        <div class="small">Tip: ~35 ml per kg</div>
      </div>
      <div class="col">
        <label>Cup size (ml)</label>
        <input id="cupSize" type="number" value="250">
      </div>
    </div>
    <div class="toolbar">
      <button id="saveWater" class="ok">Save</button>
      <button id="drink">Drink 1 cup</button>
      <button id="resetWater" class="ghost">Reset Today</button>
    </div>
    <div class="row">
      <div class="col">
        <div>Progress: <span id="waterProgTxt">0 / 0 ml</span></div>
        <progress id="waterProg" max="100" value="0"></progress>
      </div>
    </div>
    <div class="cups" id="cups"></div>
  </div>

  <!-- Profile -->
  <div id="profile" class="card hidden">
    <h2>Profile</h2>
    <div id="profSummary"></div>
    <div class="toolbar"><button id="restart" class="warn">Restart Wizard</button></div>
  </div>

  <!-- About -->
  <div id="about" class="card hidden">
    <h2>About</h2>
    <p>This MVP runs fully in your browser. AI detection uses a generic MobileNet image classifier (best‑effort). Always adjust items/portions manually for accuracy.</p>
    <p>Data is stored locally (this device only).</p>
  </div>

  <footer>© 2025 — MVP built for you. Monochrome edition.</footer>
</div>

<!-- TF.js & MobileNet -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>

<script>
// ====== i18n (expanded & usable) ======
const I18N = {
  en:{title:"AI Calorie & Macro Tracker", next:"Next", back:"Back", finish:"Finish", home:"Home", goals:"Daily Goals", camera:"Camera", log:"Food Log", dishes:"Make a Dish", water:"Water", profile:"Profile", about:"About", chooseLang:"Choose Language", language:"Language", hint:"Examples: rice, chicken breast, apple, pizza"},
  ar:{title:"حساب السعرات والماكروز بالذكاء الاصطناعي", next:"التالي", back:"رجوع", finish:"إنهاء", home:"الرئيسية", goals:"الأهداف اليومية", camera:"الكاميرا", log:"سجل الأكل", dishes:"اصنع طبق", water:"الماء", profile:"الملف", about:"عن التطبيق", chooseLang:"اختر اللغة", language:"اللغة", hint:"أمثلة: أرز، صدر دجاج، تفاح، بيتزا"},
  fr:{title:"Suivi Calories & Macros IA", next:"Suivant", back:"Retour", finish:"Terminer", home:"Accueil", goals:"Objectifs", camera:"Caméra", log:"Journal", dishes:"Créer un Plat", water:"Eau", profile:"Profil", about:"À propos", chooseLang:"Choisir la langue", language:"Langue", hint:"Exemples : riz, blanc de poulet, pomme, pizza"},
  es:{title:"Contador de Calorías y Macros IA", next:"Siguiente", back:"Atrás", finish:"Finalizar", home:"Inicio", goals:"Objetivos", camera:"Cámara", log:"Registro", dishes:"Crear Plato", water:"Agua", profile:"Perfil", about:"Acerca de", chooseLang:"Elegir idioma", language:"Idioma", hint:"Ejemplos: arroz, pechuga de pollo, manzana, pizza"}
};
const LANGS = [
  {k:'ar',label:'العربية'}, {k:'en',label:'English'}, {k:'fr',label:'Français'}, {k:'es',label:'Español'}
];
let LANG = 'ar';

function fillLangSelects(){
  const selects=[document.getElementById('langSelect'), document.getElementById('wLangSelect')];
  selects.forEach(sel=>{ 
    sel.innerHTML=''; 
    LANGS.forEach(({k,label})=>{ 
      const o=document.createElement('option'); 
      o.value=k; 
      o.textContent=label; 
      sel.appendChild(o); 
    }); 
  });
}

function setLang(k){
  LANG = k; 
  const T = I18N[k]||I18N.en;
  document.getElementById('appTitle').textContent = T.title;
  document.getElementById('wTitle').textContent = T.chooseLang;
  document.getElementById('langLabel').textContent = T.language;
  document.getElementById('wLangLabel').textContent = T.language;
  document.querySelectorAll('#nav button').forEach(b=>{ 
    const key=b.dataset.tab; 
    if(T[key]) b.textContent=T[key]; 
  });
  document.getElementById('foodHint').textContent = T.hint;
  // dir
  document.documentElement.dir = (k==='ar') ? 'rtl' : 'ltr';
  document.documentElement.lang = k;
  // set selects
  document.getElementById('langSelect').value = k;
  document.getElementById('wLangSelect').value = k;
  
  // Update food lists when language changes
  updateFoodLists();
}

// ====== State & Storage ======
const SKEY = 'mvp_tracker_state_v2_mono';
let state = JSON.parse(localStorage.getItem(SKEY) || '{}');

// Initialize state with defaults if empty
if (!state.daysData) state.daysData = {};
if (!state.foods) state.foods = [];
if (!state.dishes) state.dishes = [];
if (!state.customGoals) state.customGoals = {};

function save(){ 
  localStorage.setItem(SKEY, JSON.stringify(state)); 
}

// ====== Wizard logic ======
const step1 = document.getElementById('step1');
const step2 = document.getElementById('step2');
const step3 = document.getElementById('step3');

function markSteps(a,b,c){
  document.getElementById('s1').className = 'step' + (a ? ' active done' : '');
  document.getElementById('s2').className = 'step' + (b ? ' active done' : '');
  document.getElementById('s3').className = 'step' + (c ? ' active done' : '');
}

document.getElementById('next1').onclick = ()=>{
  const lang = document.getElementById('wLangSelect').value; 
  setLang(lang);
  state.lang = lang; 
  save();
  step1.classList.add('hidden'); 
  step2.classList.remove('hidden'); 
  markSteps(false,true,false);
};

document.getElementById('langSelect').onchange = (e)=>{ 
  setLang(e.target.value); 
  state.lang=e.target.value; 
  save(); 
};

document.getElementById('back2').onclick = ()=>{ 
  step2.classList.add('hidden'); 
  step1.classList.remove('hidden'); 
  markSteps(true,false,false); 
};

document.getElementById('next2').onclick = ()=>{
  state.sex = document.getElementById('sex').value;
  state.age = +document.getElementById('age').value;
  state.height = +document.getElementById('height').value;
  state.weight = +document.getElementById('weight').value;
  save();
  step2.classList.add('hidden'); 
  step3.classList.remove('hidden'); 
  markSteps(false,false,true);
};

document.getElementById('back3').onclick = ()=>{ 
  step3.classList.add('hidden'); 
  step2.classList.remove('hidden'); 
  markSteps(false,true,false); 
};

document.getElementById('finish').onclick = ()=>{
  state.days = +document.getElementById('days').value;
  state.goal = document.getElementById('goal').value;
  calcGoalsFromProfile();
  save();
  document.getElementById('wizard').classList.add('hidden');
  document.getElementById('nav').classList.remove('hidden');
  showTab('home');
};

// ====== Tabs ======
const tabs = ['home','goals','camera','log','dishes','water','profile','about'];
document.getElementById('nav').addEventListener('click', (e)=>{
  if(e.target.tagName!=='BUTTON') return;
  showTab(e.target.dataset.tab);
});

function showTab(id){
  tabs.forEach(t=>document.getElementById(t).classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  if(id==='home') refreshDashboard();
  if(id==='log') refreshLog();
  if(id==='water') refreshWaterUI();
  if(id==='profile') renderProfile();
  if(id==='goals') refreshCustomGoals();
  if(id==='dishes') refreshDishes();
}

document.getElementById('toCamera').onclick=()=>showTab('camera');
document.getElementById('toLog').onclick=()=>showTab('log');

// ====== Calculations ======
function activityFactor(days){
  if(days<=0) return 1.2;
  if(days<=2) return 1.375;
  if(days<=4) return 1.55;
  if(days<=6) return 1.725;
  return 1.9;
}

function calcTDEE(){
  const w=state.weight||70, h=state.height||175, a=state.age||25, s=state.sex||'male', d=state.days||3;
  const bmr = (s==='male') ? (10*w + 6.25*h - 5*a + 5) : (10*w + 6.25*h - 5*a - 161);
  let tdee = bmr * activityFactor(d);
  if(state.goal==='cut') tdee *= 0.85;
  if(state.goal==='bulk') tdee *= 1.10;
  return Math.round(tdee);
}

function calcMacros(){
  const kcal = calcTDEE();
  const prot = Math.round((state.weight||70) * 1.8); // g
  const fat = Math.round((state.weight||70) * 0.9); // g
  let restK = kcal - (prot*4 + fat*9);
  const carb = Math.max(0, Math.round(restK/4));
  return {kcal, prot, fat, carb};
}

function calcGoalsFromProfile(){
  const m = calcMacros();
  state.goals = m; 
  save();
  fillGoals();
}

// ====== Goals UI ======
function fillGoals(){
  const g = state.goals || calcMacros();
  ['kcal','prot','fat','carb'].forEach(k=>{ 
    document.getElementById('g_'+k).value = g[k]; 
  });
  refreshDashboard();
}

document.getElementById('saveGoals').onclick = ()=>{
  state.goals = {
    kcal:+document.getElementById('g_kcal').value,
    prot:+document.getElementById('g_prot').value,
    fat:+document.getElementById('g_fat').value,
    carb:+document.getElementById('g_carb').value
  };
  save(); 
  refreshDashboard();
};

document.getElementById('recalcGoals').onclick = ()=>{ 
  calcGoalsFromProfile(); 
};

// ====== Dashboard ======
function todayKey(){ 
  const d=new Date(); 
  return d.toISOString().slice(0,10); 
}

function getDay(day=todayKey()){ 
  if (!state.daysData[day]) {
    state.daysData[day] = {meals:[], water:0};
  }
  return state.daysData[day]; 
}

function sumDay(day=todayKey()){ 
  const obj = getDay(day); 
  return obj.meals.reduce((acc,m)=>{ 
    acc.kcal += m.kcal; 
    acc.prot += m.prot; 
    acc.fat += m.fat; 
    acc.carb += m.carb; 
    return acc; 
  }, {kcal:0,prot:0,fat:0,carb:0}); 
}

function refreshDashboard(){
  const g = state.goals || calcMacros();
  const s = sumDay();
  document.getElementById('kcalToday').textContent = Math.round(s.kcal);
  document.getElementById('protToday').textContent = Math.round(s.prot);
  document.getElementById('fatToday').textContent = Math.round(s.fat);
  document.getElementById('carbToday').textContent = Math.round(s.carb);
  document.getElementById('kcalTarget').textContent = g.kcal;
  document.getElementById('protTarget').textContent = g.prot;
  document.getElementById('fatTarget').textContent = g.fat;
  document.getElementById('carbTarget').textContent = g.carb;
  document.getElementById('kcalProg').value = Math.min(100, (s.kcal/g.kcal)*100);
  document.getElementById('protProg').value = Math.min(100, (s.prot/g.prot)*100);
  document.getElementById('fatProg').value = Math.min(100, (s.fat/g.fat)*100);
  document.getElementById('carbProg').value = Math.min(100, (s.carb/g.carb)*100);
  updateStreak();
}

// ====== Foods DB ======
const SEED_FOODS = [
  {name:"white rice", ar:"رز أبيض مطبوخ", kcal:130, prot:2.4, fat:0.3, carb:28.7},
  {name:"brown rice", ar:"رز بني", kcal:123, prot:2.7, fat:1.0, carb:25.6},
  {name:"grilled chicken breast", ar:"صدر دجاج مشوي", kcal:165, prot:31, fat:3.6, carb:0},
  {name:"beef steak lean", ar:"ستيك بقري قليل الدهن", kcal:187, prot:27, fat:8, carb:0},
  {name:"ground beef 80/20", ar:"لحمة مفرومة 20% دهن", kcal:254, prot:17, fat:20, carb:0},
  {name:"lamb", ar:"لحم ضأن", kcal:258, prot:25, fat:17, carb:0},
  {name:"salmon", ar:"سالمون", kcal:208, prot:20, fat:13, carb:0},
  {name:"tuna canned water", ar:"تونة معلبة", kcal:132, prot:29, fat:1, carb:0},
  {name:"eggs", ar:"بيض", kcal:155, prot:13, fat:11, carb:1.1},
  {name:"egg whites", ar:"بياض بيض", kcal:52, prot:11, fat:0.2, carb:0.7},
  {name:"whole milk", ar:"حليب كامل الدسم", kcal:61, prot:3.2, fat:3.3, carb:4.8},
  {name:"yogurt plain", ar:"زبادي طبيعي", kcal:61, prot:3.5, fat:3.3, carb:4.7},
  {name:"feta cheese", ar:"جبنة فيتا", kcal:264, prot:14, fat:21, carb:4.1},
  {name:"cheddar cheese", ar:"جبنة شيدر", kcal:404, prot:23, fat:33, carb:1.3},
  {name:"bread white", ar:"خبز أبيض", kcal:265, prot:9, fat:3.2, carb:49},
  {name:"bread whole wheat", ar:"خبز قمح كامل", kcal:265, prot:13, fat:4.4, carb:48},
  {name:"pasta cooked", ar:"مكرونة مسلوقة", kcal:131, prot:5, fat:1, carb:25},
  {name:"lentils cooked", ar:"عدس مطبوخ", kcal:116, prot:9, fat:0.4, carb:20},
  {name:"chickpeas cooked", ar:"حمص مطبوخ", kcal:139, prot:7, fat:2.8, carb:22},
  {name:"potato baked", ar:"بطاطس مشوية", kcal:93, prot:2.5, fat:0.1, carb:21},
  {name:"sweet potato baked", ar:"بطاطا حلوة مشوية", kcal:90, prot:2, fat:0.2, carb:21},
  {name:"broccoli steamed", ar:"بروكلي مطبوخ", kcal:35, prot:2.4, fat:0.4, carb:7},
  {name:"spinach raw", ar:"سبانخ طازجة", kcal:23, prot:2.9, fat:0.4, carb:3.6},
  {name:"carrots raw", ar:"جزر طازج", kcal:41, prot:0.9, fat:0.2, carb:10},
  {name:"tomato", ar:"طماطم", kcal:18, prot:0.9, fat:0.2, carb:3.9},
  {name:"cucumber", ar:"خيار", kcal:15, prot:0.7, fat:0.1, carb:3.6},
  {name:"lettuce", ar:"خس", kcal:15, prot:1.4, fat:0.2, carb:2.9},
  {name:"onion", ar:"بصل", kcal:40, prot:1.1, fat:0.1, carb:9.3},
  {name:"apple", ar:"تفاح", kcal:52, prot:0.3, fat:0.2, carb:14},
  {name:"banana", ar:"موز", kcal:89, prot:1.1, fat:0.3, carb:23},
  {name:"orange", ar:"برتقال", kcal:47, prot:0.9, fat:0.1, carb:12},
  {name:"strawberries", ar:"فراولة", kcal:32, prot:0.7, fat:0.3, carb:7.7},
  {name:"avocado", ar:"أفوكادو", kcal:160, prot:2, fat:15, carb:9},
  {name:"olive oil", ar:"زيت زيتون", kcal:884, prot:0, fat:100, carb:0},
  {name:"butter", ar:"زبدة", kcal:717, prot:0.9, fat:81, carb:0.1},
  {name:"sugar", ar:"سكر", kcal:387, prot:0, fat:0, carb:100},
  {name:"honey", ar:"عسل", kcal:304, prot:0.3, fat:0, carb:82},
  {name:"pizza cheese", ar:"بيتزا بالجبن", kcal:268, prot:11, fat:9.8, carb:33},
  {name:"burger with bun", ar:"برجر بالخبز", kcal:295, prot:16, fat:13, carb:28},
  {name:"french fries", ar:"بطاطس مقلية", kcal:312, prot:3.4, fat:15, carb:41},
  {name:"cola", ar:"كولا", kcal:41, prot:0, fat:0, carb:10},
  {name:"coffee black", ar:"قهوة سوداء", kcal:1, prot:0.1, fat:0, carb:0},
  {name:"tea no sugar", ar:"شاي بدون سكر", kcal:1, prot:0, fat:0, carb:0},
  {name:"water", ar:"ماء", kcal:0, prot:0, fat:0, carb:0}
];

// Initialize foods if empty
if (!state.foods || state.foods.length === 0) {
  state.foods = SEED_FOODS;
  save();
}

function updateFoodLists() {
  const foodList = document.getElementById('foodList');
  const ingredientSelects = document.querySelectorAll('.ingredientSelect');
  
  // Clear existing options
  foodList.innerHTML = '';
  ingredientSelects.forEach(select => {
    select.innerHTML = '<option value="">Select ingredient</option>';
  });
  
  // Add foods based on current language
  state.foods.forEach(food => {
    // Add to datalist
    const option = document.createElement('option');
    option.value = food[LANG] || food.name;
    option.setAttribute('data-name', food.name);
    foodList.appendChild(option);
    
    // Add to ingredient selects
    ingredientSelects.forEach(select => {
      const option2 = document.createElement('option');
      option2.value = food.name;
      option2.textContent = food[LANG] || food.name;
      select.appendChild(option2);
    });
  });
}

// ====== Camera & AI ======
let model, stream, video, canvas, ctx;

document.getElementById('startCam').onclick = async ()=>{
  video = document.getElementById('vid');
  canvas = document.getElementById('frame');
  ctx = canvas.getContext('2d');
  stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
  video.srcObject = stream;
  document.getElementById('stopCam').classList.remove('hidden');
  document.getElementById('snap').classList.remove('ghost');
  document.getElementById('classify').classList.remove('ghost');
};

document.getElementById('stopCam').onclick = ()=>{
  if(stream) stream.getTracks().forEach(t=>t.stop());
  document.getElementById('stopCam').classList.add('hidden');
  document.getElementById('snap').classList.add('ghost');
  document.getElementById('classify').classList.add('ghost');
};

document.getElementById('snap').onclick = ()=>{
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video,0,0);
  canvas.classList.remove('hidden');
  video.classList.add('hidden');
};

document.getElementById('classify').onclick = async ()=>{
  if(!model) model = await mobilenet.load({version:2, alpha:1.0});
  const pred = await model.classify(canvas);
  const predDiv = document.getElementById('pred');
  predDiv.innerHTML = '';
  pred.forEach((p,i)=>{
    const b = document.createElement('button');
    b.className = 'tag';
    b.textContent = `${p.className} (${Math.round(p.probability*100)}%)`;
    b.onclick = ()=> document.getElementById('foodSearch').value = p.className;
    predDiv.appendChild(b);
  });
};

// Portion estimation based on food size
document.getElementById('foodSize').onchange = function() {
  const size = this.value;
  let weight = 100;
  if (size === 'small') weight = 50;
  if (size === 'medium') weight = 150;
  if (size === 'large') weight = 250;
  if (size === 'bowl') weight = 300;
  if (size === 'plate') weight = 500;
  document.getElementById('estimatedWeight').value = weight;
  document.getElementById('portion').value = weight;
};

// ====== Add to Meal ======
document.getElementById('addMeal').onclick = ()=>{
  const foodName = document.getElementById('foodSearch').value;
  const portion = +document.getElementById('portion').value;
  const meal = document.getElementById('mealType').value;
  
  // Find food in database
  const food = state.foods.find(f => 
    f.name === foodName || f[LANG] === foodName
  );
  
  if(!food) {
    alert('Food not found. Please select from list or add to database first.');
    return;
  }
  
  const factor = portion / 100;
  const mealItem = {
    food: food[LANG] || food.name,
    meal,
    grams: portion,
    kcal: Math.round(food.kcal * factor),
    prot: Math.round(food.prot * factor * 10) / 10,
    fat: Math.round(food.fat * factor * 10) / 10,
    carb: Math.round(food.carb * factor * 10) / 10
  };
  
  const day = getDay();
  day.meals.push(mealItem);
  save();
  refreshDashboard();
  refreshLog();
  
  // Reset form
  document.getElementById('foodSearch').value = '';
  document.getElementById('portion').value = 150;
};

// ====== Log ======
function refreshLog(){
  const day = getDay();
  const s = sumDay();
  document.getElementById('logDate').textContent = todayKey();
  document.getElementById('tKcal').textContent = Math.round(s.kcal);
  document.getElementById('tP').textContent = Math.round(s.prot);
  document.getElementById('tF').textContent = Math.round(s.fat);
  document.getElementById('tC').textContent = Math.round(s.carb);
  
  const tbody = document.getElementById('logTable');
  tbody.innerHTML = '';
  day.meals.forEach((m,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${m.meal}</td>
      <td>${m.food}</td>
      <td>${m.grams}</td>
      <td>${m.kcal}</td>
      <td>${m.prot}</td>
      <td>${m.fat}</td>
      <td>${m.carb}</td>
      <td><button class="danger" onclick="removeMeal(${i})">×</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function removeMeal(i){
  const day = getDay();
  day.meals.splice(i,1);
  save();
  refreshLog();
  refreshDashboard();
}

document.getElementById('clearToday').onclick = ()=>{
  if(confirm('Clear all meals for today?')){
    const day = getDay();
    day.meals = [];
    save();
    refreshLog();
    refreshDashboard();
  }
};

// ====== Streak ======
function updateStreak(){
  const today = todayKey();
  const days = Object.keys(state.daysData).sort();
  let streak = 0;
  let last = new Date(today);
  
  for(let i=days.length-1; i>=0; i--){
    const d = new Date(days[i]);
    const diff = (last - d) / (1000*60*60*24);
    if(diff > 1) break;
    if(state.daysData[days[i]].meals.length > 0){
      streak++;
      last = new Date(d.setDate(d.getDate()-1));
    }
  }
  
  document.getElementById('streak').textContent = streak;
}

// ====== Water Tracker ======
function refreshWaterUI(){
  const day = getDay();
  const target = +(state.waterTarget || 2500);
  const cup = +(state.cupSize || 250);
  const current = day.water || 0;
  const cups = Math.ceil(target / cup);
  
  document.getElementById('waterTarget').value = target;
  document.getElementById('cupSize').value = cup;
  document.getElementById('waterProgTxt').textContent = `${current} / ${target} ml`;
  document.getElementById('waterProg').value = (current / target) * 100;
  
  const cupsDiv = document.getElementById('cups');
  cupsDiv.innerHTML = '';
  for(let i=0; i<cups; i++){
    const c = document.createElement('div');
    c.className = 'cup' + (i < Math.floor(current/cup) ? ' fill' : '');
    c.onclick = ()=> drinkWater(cup);
    cupsDiv.appendChild(c);
  }
}

function drinkWater(amt){
  const day = getDay();
  day.water = (day.water || 0) + amt;
  save();
  refreshWaterUI();
}

document.getElementById('saveWater').onclick = ()=>{
  state.waterTarget = +document.getElementById('waterTarget').value;
  state.cupSize = +document.getElementById('cupSize').value;
  save();
  refreshWaterUI();
};

document.getElementById('drink').onclick = ()=>{
  const cup = +(state.cupSize || 250);
  drinkWater(cup);
};

document.getElementById('resetWater').onclick = ()=>{
  const day = getDay();
  day.water = 0;
  save();
  refreshWaterUI();
};

// ====== Profile ======
function renderProfile(){
  const s = state;
  const html = `
    <div class="row">
      <div class="col"><strong>Sex:</strong> ${s.sex||'?'}</div>
      <div class="col"><strong>Age:</strong> ${s.age||'?'}</div>
    </div>
    <div class="row">
      <div class="col"><strong>Height:</strong> ${s.height||'?'} cm</div>
      <div class="col"><strong>Weight:</strong> ${s.weight||'?'} kg</div>
    </div>
    <div class="row">
      <div class="col"><strong>Workout days:</strong> ${s.days||'?'}/week</div>
      <div class="col"><strong>Goal:</strong> ${s.goal||'?'}</div>
    </div>
    <div class="row">
      <div class="col"><strong>TDEE:</strong> ${calcTDEE()} kcal</div>
    </div>
  `;
  document.getElementById('profSummary').innerHTML = html;
}

document.getElementById('restart').onclick = ()=>{
  document.getElementById('wizard').classList.remove('hidden');
  document.getElementById('nav').classList.add('hidden');
};

// ====== Custom Goals ======
function refreshCustomGoals() {
  const list = document.getElementById('customGoalsList');
  list.innerHTML = '';
  
  const today = todayKey();
  const todayGoals = state.customGoals[today] || [];
  
  todayGoals.forEach((goal, index) => {
    const goalItem = document.createElement('div');
    goalItem.className = 'custom-goal-item';
    
    const checkbox = document.createElement('div');
    checkbox.className = `custom-goal-checkbox ${goal.completed ? 'checked' : ''}`;
    checkbox.onclick = () => toggleCustomGoal(index);
    
    const text = document.createElement('div');
    text.className = `custom-goal-text ${goal.completed ? 'goal-completed' : ''}`;
    text.textContent = goal.text;
    
    const removeBtn = document.createElement('button');
    removeBtn.className = 'custom-goal-remove';
    removeBtn.innerHTML = '×';
    removeBtn.onclick = (e) => {
      e.stopPropagation();
      removeCustomGoal(index);
    };
    
    goalItem.appendChild(checkbox);
    goalItem.appendChild(text);
    goalItem.appendChild(removeBtn);
    list.appendChild(goalItem);
  });
}

document.getElementById('addCustomGoal').onclick = () => {
  const input = document.getElementById('newCustomGoal');
  const text = input.value.trim();
  
  if (!text) return;
  
  const today = todayKey();
  if (!state.customGoals[today]) {
    state.customGoals[today] = [];
  }
  
  state.customGoals[today].push({
    text: text,
    completed: false
  });
  
  save();
  refreshCustomGoals();
  input.value = '';
};

function toggleCustomGoal(index) {
  const today = todayKey();
  if (state.customGoals[today] && state.customGoals[today][index]) {
    state.customGoals[today][index].completed = !state.customGoals[today][index].completed;
    save();
    refreshCustomGoals();
  }
}

function removeCustomGoal(index) {
  const today = todayKey();
  if (state.customGoals[today] && state.customGoals[today][index]) {
    state.customGoals[today].splice(index, 1);
    save();
    refreshCustomGoals();
  }
}

// ====== Make a Dish ======
function refreshDishes() {
  // Update ingredient selects
  updateFoodLists();
  
  // Display saved dishes
  const savedDishesDiv = document.getElementById('savedDishes');
  savedDishesDiv.innerHTML = '';
  
  state.dishes.forEach((dish, index) => {
    const dishDiv = document.createElement('div');
    dishDiv.className = 'dish-saved';
    
    dishDiv.innerHTML = `
      <h4>${dish.name}</h4>
      <div class="small">Ingredients: ${dish.ingredients.map(i => 
        `${i.ingredient} (${i.grams}g)`
      ).join(', ')}</div>
      <div class="row">
        <div class="col"><strong>Calories:</strong> ${dish.kcal}/100g</div>
        <div class="col"><strong>Protein:</strong> ${dish.prot}g</div>
        <div class="col"><strong>Fat:</strong> ${dish.fat}g</div>
        <div class="col"><strong>Carbs:</strong> ${dish.carb}g</div>
      </div>
      <div class="toolbar">
        <button class="ok" onclick="addDishToLog(${index})">Add to Today's Log</button>
        <button class="danger" onclick="deleteDish(${index})">Delete</button>
      </div>
    `;
    
    savedDishesDiv.appendChild(dishDiv);
  });
}

// Add ingredient row
document.getElementById('addIngredient').onclick = () => {
  const container = document.getElementById('dishIngredients');
  const newRow = document.createElement('div');
  newRow.className = 'dish-ingredient-grid';
  newRow.innerHTML = `
    <select class="ingredientSelect">
      <option value="">Select ingredient</option>
    </select>
    <input type="number" class="ingredientGrams" placeholder="Grams" value="100">
    <span class="small">Portion</span>
    <button class="removeIngredient danger">×</button>
  `;
  container.appendChild(newRow);
  
  // Update the new select with foods
  updateFoodLists();
  
  // Add remove functionality
  newRow.querySelector('.removeIngredient').onclick = () => {
    if (container.children.length > 1) {
      newRow.remove();
    }
  };
};

// Calculate dish nutrition
document.getElementById('calculateDish').onclick = () => {
  const ingredients = [];
  let totalWeight = 0;
  
  // Collect all ingredients
  document.querySelectorAll('.dish-ingredient-grid').forEach(row => {
    const select = row.querySelector('.ingredientSelect');
    const grams = +row.querySelector('.ingredientGrams').value;
    
    if (select.value && grams > 0) {
      const food = state.foods.find(f => f.name === select.value);
      if (food) {
        ingredients.push({
          food,
          grams
        });
        totalWeight += grams;
      }
    }
  });
  
  if (ingredients.length === 0) {
    alert('Please add at least one ingredient');
    return;
  }
  
  // Calculate totals
  let totalKcal = 0, totalProt = 0, totalFat = 0, totalCarb = 0;
  
  ingredients.forEach(ing => {
    const factor = ing.grams / 100;
    totalKcal += ing.food.kcal * factor;
    totalProt += ing.food.prot * factor;
    totalFat += ing.food.fat * factor;
    totalCarb += ing.food.carb * factor;
  });
  
  // Calculate per 100g
  const factor = 100 / totalWeight;
  const dishKcal = Math.round(totalKcal * factor);
  const dishProt = Math.round(totalProt * factor * 10) / 10;
  const dishFat = Math.round(totalFat * factor * 10) / 10;
  const dishCarb = Math.round(totalCarb * factor * 10) / 10;
  
  // Display results
  document.getElementById('dishKcal').textContent = dishKcal;
  document.getElementById('dishProt').textContent = dishProt;
  document.getElementById('dishFat').textContent = dishFat;
  document.getElementById('dishCarb').textContent = dishCarb;
  document.getElementById('dishResults').classList.remove('hidden');
  
  // Store calculated dish data temporarily
  window.currentDish = {
    name: document.getElementById('dishName').value || 'Unnamed Dish',
    ingredients: ingredients.map(ing => ({
      ingredient: ing.food.name,
      grams: ing.grams
    })),
    totalWeight,
    kcal: dishKcal,
    prot: dishProt,
    fat: dishFat,
    carb: dishCarb
  };
};

// Save dish
document.getElementById('saveDish').onclick = () => {
  if (!window.currentDish) {
    alert('Please calculate the dish first');
    return;
  }
  
  if (!state.dishes) state.dishes = [];
  state.dishes.push(window.currentDish);
  save();
  refreshDishes();
  
  // Reset form
  document.getElementById('dishName').value = '';
  document.getElementById('dishIngredients').innerHTML = `
    <div class="dish-ingredient-grid">
      <select class="ingredientSelect">
        <option value="">Select ingredient</option>
      </select>
      <input type="number" class="ingredientGrams" placeholder="Grams" value="100">
      <span class="small">Portion</span>
      <button class="removeIngredient danger">×</button>
    </div>
  `;
  document.getElementById('dishResults').classList.add('hidden');
  updateFoodLists();
  
  alert('Dish saved successfully!');
};

// Add dish to log
function addDishToLog(dishIndex) {
  const dish = state.dishes[dishIndex];
  const portion = prompt(`Enter portion size in grams for "${dish.name}" (total weight: ${dish.totalWeight}g):`, "100");
  
  if (!portion || isNaN(portion)) return;
  
  const factor = portion / 100;
  const mealItem = {
    food: dish.name,
    meal: 'Lunch', // Default to lunch
    grams: +portion,
    kcal: Math.round(dish.kcal * factor),
    prot: Math.round(dish.prot * factor * 10) / 10,
    fat: Math.round(dish.fat * factor * 10) / 10,
    carb: Math.round(dish.carb * factor * 10) / 10
  };
  
  const day = getDay();
  day.meals.push(mealItem);
  save();
  refreshDashboard();
  refreshLog();
  alert('Dish added to today\'s log!');
}

// Delete dish
function deleteDish(dishIndex) {
  if (confirm('Are you sure you want to delete this dish?')) {
    state.dishes.splice(dishIndex, 1);
    save();
    refreshDishes();
  }
}

// ====== Init ======
fillLangSelects();
if(state.lang) setLang(state.lang); 
else setLang('ar');

if(state.weight && state.goal){
  document.getElementById('wizard').classList.add('hidden');
  document.getElementById('nav').classList.remove('hidden');
  showTab('home');
  fillGoals();
} else {
  document.getElementById('wizard').classList.remove('hidden');
  document.getElementById('nav').classList.add('hidden');
}

// Initialize food lists
updateFoodLists();
</script>
</body>
</html>